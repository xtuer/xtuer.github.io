<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>组播 | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="夜深人静，一个小黑屋子里发出神秘的嘀嘀嘀……嗒嗒嗒……嘀嘀嘀…… 的声音，谍战剧必不可少的画面 Multicast 和发电报有相似之处，一条消息发送给多个既定的目标群体。">
<meta property="og:type" content="article">
<meta property="og:title" content="组播">
<meta property="og:url" content="http://xtuer.github.io/qtbook-network-udp-multicast/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="夜深人静，一个小黑屋子里发出神秘的嘀嘀嘀……嗒嗒嗒……嘀嘀嘀…… 的声音，谍战剧必不可少的画面 Multicast 和发电报有相似之处，一条消息发送给多个既定的目标群体。">
<meta property="og:locale">
<meta property="og:image" content="http://xtuer.github.io/img/qtbook/network/Network-UDP-Multicast-Movie-1.jpg">
<meta property="og:image" content="http://xtuer.github.io/img/qtbook/network/Network-UDP-Multicast.png">
<meta property="article:published_time" content="2016-12-19T11:26:54.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.175Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="QtBook">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xtuer.github.io/img/qtbook/network/Network-UDP-Multicast-Movie-1.jpg">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/">公孙二狗</a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		<p class="header-subtitle">大圣，此去欲何？踏南天，碎凌霄。若一去不回……？便一去不回！</p>
		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 11.76px;">Cas</a> <a href="/tags/DB/" style="font-size: 14.71px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 13.53px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 11.76px;">Hexo</a> <a href="/tags/Index/" style="font-size: 12.35px;">Index</a> <a href="/tags/Java/" style="font-size: 19.41px;">Java</a> <a href="/tags/Mac/" style="font-size: 17.65px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.06px;">Misc</a> <a href="/tags/PHP/" style="font-size: 10.59px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.24px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.82px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 10.59px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 13.53px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.18px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 12.94px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 15.29px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 14.12px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 14.71px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 16.47px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 16.47px;">Util</a> <a href="/tags/Vue/" style="font-size: 15.88px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.18px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-6"><a class="toc-link" href="#Multicast-%E7%9A%84%E9%80%BB%E8%BE%91%E5%A4%A7%E8%87%B4%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-text">Multicast 的逻辑大致如下：</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multicast-%E7%9A%84%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%A8%8B%E5%BA%8F"><span class="toc-text">Multicast 的消息发送程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multicast-%E7%9A%84%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6%E7%A8%8B%E5%BA%8F"><span class="toc-text">Multicast 的消息接收程序</span></a>
            </div>
        </div>
    </div>


<article id="post-qtbook-network-udp-multicast" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/qtbook-network-udp-multicast/" class="article-date">
  	<!-- <time datetime="2016-12-19T11:26:54.000Z" itemprop="datePublished">2016-12-19</time> -->
    2016-12-19
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      组播
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QtBook/" rel="tag">QtBook</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p>夜深人静，一个小黑屋子里发出神秘的嘀嘀嘀……嗒嗒嗒……嘀嘀嘀…… 的声音，谍战剧必不可少的画面<br><img src="../img/qtbook/network/Network-UDP-Multicast-Movie-1.jpg"></p>
<p>Multicast 和发电报有相似之处，一条消息发送给多个既定的目标群体。<span id="more"></span></p>
<p>下面一段话对 Multicast 的描述比我能描述的好很多：</p>
<blockquote>
<p>Multicasting identifies logical groups of computers. A single message can then be sent to the group.</p>
<p>Multicasting uses the Internet Group Management Protocol (IGMP) to identify groups and group members. Routers will also use IGMP to send messages to subnets that have group members. The router actually doesn’t keep track of which hosts are members of which group, only that the subnet contains at least one member for each group. If we have multiple routers, they will communicate and exchange information about multicast groups that they have.</p>
<p>Each host on the network can belong to multiple multicast groups. Hosts can join or leave groups at any time. Multicast groups are identified by special IP addresses between the range of 224.0.0.0 and 239.255.255.255. Each group is assigned it’s own address. Addresses within the 224.0.0.0 range are reserved for local subnet communications.</p>
<p>When we use a switch to connect hosts, multicast messages are actually forwarded to all hosts on the hub or the switch.</p>
</blockquote>
<p>如果对上面的内容理解有困难，可以搜索一下 Multicast 的理论，这里就不再赘述教科书上的内容了，只是简单的介绍和 Multicast 编程相关的主要部分，为了不要又臭又长，有些地方描述的不够准确，希望多多包涵，关键是理解重点，细节的地方请参考相关理论。</p>
<p>额外提一点，和 Broadcast 不同是的 Multicast 可以跨网段，但是需要交换机的支持。</p>
<p>Multicast 编程最关键的地方是：Multicast 的组是使用 IP 来标记的，不同的 IP 表示不同的组，Multicast 使用的 IP 地址范围是 <code>224.0.0.0</code> 到 <code>239.255.255.255</code> 之间。</p>
<h6 id="Multicast-的逻辑大致如下："><a href="#Multicast-的逻辑大致如下：" class="headerlink" title="Multicast 的逻辑大致如下："></a>Multicast 的逻辑大致如下：</h6><ol>
<li>例如我们使用 IP 225.20.40.20 定义一个 Multicast 的组</li>
<li>有多个客户端加入这个组（客户端就是我们写的接收 Multicast 消息的软件，加入时使用的 IP 也是 225.20.40.20，这个 IP 就是组的 ID）</li>
<li>发送 Multicast 消息给这个组时（消息的 Destination 的 IP 是 225.20.40.20）</li>
<li>所有加入到这个组的客户端都能接收到这个消息，实现了消息的按组发送。</li>
</ol>
<p>下图是 Multicast 的示意图，Source 发送 Multicast 消息，只有加入组的 Destination 1，Destination 2， Destination 3 都能收到这个消息：<br><img src="../img/qtbook/network/Network-UDP-Multicast.png"></p>
<h2 id="Multicast-的消息发送程序"><a href="#Multicast-的消息发送程序" class="headerlink" title="Multicast 的消息发送程序"></a>Multicast 的消息发送程序</h2><p>Multicast 发送消息的程序和 Unicast 的几乎完全一样，只需要把<br><code>udpSocket-&gt;writeDatagram(data.toUtf8(), QHostAddress::LocalHost, 13930)</code><br>替换为<br><code>udpSocket-&gt;writeDatagram(data.toUtf8(), multicastAddress, 13930)</code><br>即把 Destination 的 Unicast 数据报的地址换为 Multicast 组的地址，这里我们只列出 main 函数，其他部分参考 Unicast 的程序。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">QHostAddress <span class="title">multicastAddress</span><span class="params">(<span class="string">&quot;225.20.40.20&quot;</span>)</span></span>; <span class="comment">// Multicast 组的地址</span></span><br><span class="line">    QUdpSocket *udpSocket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>();</span><br><span class="line">    <span class="keyword">int</span> messageCount = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; messageCount; ++i) &#123;</span><br><span class="line">        QString data = <span class="built_in">generateMessage</span>(i, <span class="string">&#x27;+&#x27;</span>);</span><br><span class="line">        <span class="comment">// 使用 Multicast 发送消息</span></span><br><span class="line">        udpSocket-&gt;<span class="built_in">writeDatagram</span>(data.<span class="built_in">toUtf8</span>(), multicastAddress, <span class="number">13930</span>);</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Multicast-的消息接收程序"><a href="#Multicast-的消息接收程序" class="headerlink" title="Multicast 的消息接收程序"></a>Multicast 的消息接收程序</h2><p>Multicast 的消息接收程序和 Unicast 的消息接收程序也是几乎完全一样，只需要把<br><code>udpSocket-&gt;bind(13930, QUdpSocket::DontShareAddress)</code><br>替换为<br><code>udpSocket-&gt;bind(QHostAddress::AnyIPv4, 13930, QUdpSocket::ShareAddress)</code><br>然后加入组<br><code>udpSocket-&gt;joinMulticastGroup(QHostAddress(&quot;225.20.40.20&quot;))</code><br>这里我们只列出 Multicast 接收程序的构造函数，其他部分和 Unicast 的程序都一样。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MulticastReceiver::<span class="built_in">MulticastReceiver</span>(QObject *parent) : <span class="built_in">QObject</span>(parent) &#123;</span><br><span class="line">    udpSocket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>();</span><br><span class="line">    udpSocket-&gt;<span class="built_in">bind</span>(QHostAddress::AnyIPv4, <span class="number">13930</span>, QUdpSocket::ShareAddress);</span><br><span class="line">    udpSocket-&gt;<span class="built_in">joinMulticastGroup</span>(<span class="built_in">QHostAddress</span>(<span class="string">&quot;225.20.40.20&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(udpSocket, <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">readPendingDatagrams</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/qtbook-db/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          数据库
        
      </div>
    </a>
  
  
    <a href="/qtbook-network-udp-broadcast/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">广播</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

    </div>
</body>

</html>
