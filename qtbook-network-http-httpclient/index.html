<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Qt 访问网络的 HttpClient | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Qt 使用 QNetworkAccessManager 访问 HTTP 服务，这里对其进行了简单的封装，使用流行的 Fluent 风格 API，简化 GET、POST、PUT、DELETE、上传、下载等操作。 在执行请求前设置需要的参数和回调函数:  调用 header() 设置请求头  调用 param() 设置参数，使用 Form 表单的方式提交请求，GET 请求的 query paramet">
<meta property="og:type" content="article">
<meta property="og:title" content="Qt 访问网络的 HttpClient">
<meta property="og:url" content="http://xtuer.github.io/qtbook-network-http-httpclient/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="Qt 使用 QNetworkAccessManager 访问 HTTP 服务，这里对其进行了简单的封装，使用流行的 Fluent 风格 API，简化 GET、POST、PUT、DELETE、上传、下载等操作。 在执行请求前设置需要的参数和回调函数:  调用 header() 设置请求头  调用 param() 设置参数，使用 Form 表单的方式提交请求，GET 请求的 query paramet">
<meta property="og:locale">
<meta property="article:published_time" content="2016-09-17T11:51:56.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.174Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="QtBook">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">

  <!-- mermaid.js 需要在 require.js 前面加载 -->
  <script src='https://unpkg.com/mermaid@8.7.0/dist/mermaid.min.js'></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/">公孙二狗</a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		<p class="header-subtitle">大圣，此去欲何？踏南天，碎凌霄。若一去不回……？便一去不回！</p>
		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 11.67px;">Cas</a> <a href="/tags/DB/" style="font-size: 15px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 13.89px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 12.22px;">Hexo</a> <a href="/tags/Index/" style="font-size: 12.78px;">Index</a> <a href="/tags/Java/" style="font-size: 19.44px;">Java</a> <a href="/tags/Mac/" style="font-size: 17.78px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.22px;">Misc</a> <a href="/tags/PHP/" style="font-size: 10.56px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.33px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.89px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 10.56px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 13.89px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.11px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.33px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 15.56px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 14.44px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 15px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 16.67px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 16.67px;">Util</a> <a href="/tags/Vue/" style="font-size: 16.11px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.11px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-cpp"><span class="toc-text">main.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpClient-h"><span class="toc-text">HttpClient.h</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpClient-cpp"><span class="toc-text">HttpClient.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">服务器端处理请求的代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-HTTPS"><span class="toc-text">使用 HTTPS</span></a></li></ol>
            </div>
        </div>
    </div>


<article id="post-qtbook-network-http-httpclient" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/qtbook-network-http-httpclient/" class="article-date">
  	<!-- <time datetime="2016-09-17T11:51:56.000Z" itemprop="datePublished">2016-09-17</time> -->
    2016-09-17
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Qt 访问网络的 HttpClient
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QtBook/" rel="tag">QtBook</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p>Qt 使用 <code>QNetworkAccessManager</code> 访问 HTTP 服务，这里对其进行了简单的封装，使用流行的 Fluent 风格 API，简化 GET、POST、PUT、DELETE、上传、下载等操作。</p>
<p>在执行请求前设置需要的参数和回调函数:</p>
<ul>
<li><p>调用 <code>header()</code> 设置请求头</p>
</li>
<li><p>调用 <code>param()</code> 设置参数，使用 Form 表单的方式提交请求，GET 请求的 query parameters 也可以用它设置</p>
</li>
<li><p>调用 <code>json()</code> 设置 JSON 字符串的 request body，Content-Type 为 application/json</p>
<p>当然也可以不是 JSON 格式，因使用 request body 的情况多数是使用 JSON 格式传递复杂对象，故命名为 json()</p>
</li>
<li><p>调用 <code>success()</code> 注册请求成功的回调函数</p>
</li>
<li><p>调用 <code>fail()</code> 注册请求失败的回调函数</p>
</li>
<li><p>调用 <code>complete()</code> 注册请求结束的回调函数</p>
</li>
</ul>
<p>然后根据请求的类型调用 <code>get()</code>, <code>post()</code>, <code>put()</code>, <code>remove()</code>, <code>download()</code>, <code>upload()</code> 执行 HTTP 请求。</p>
<blockquote>
<p><code>success()</code>, <code>fail()</code>, <code>complete()</code> 的回调函数是可选的，根据需要注册对应的回调函数，也可以一个都不注册</p>
</blockquote>
<p>例如使用 HttpClient 执行 GET 请求的代码可以简化为:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">HttpClient</span>(<span class="string">&quot;http://localhost:8080/api/rest&quot;</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">    <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">&#125;).<span class="built_in">get</span>();</span><br></pre></td></tr></table></figure>

<span id="more"></span>
<p>更多的使用方法请参考 <code>main()</code> 里的例子，展示了各种用法。</p>
<h2 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h2><p><code>main()</code> 函数里展示了 <code>HttpClient</code> 的使用示例。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HttpClient.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QNetworkAccessManager&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在代码块里执行网络访问，是为了测试 HttpClient 对象在被析构后，网络访问的回调函数仍然能正常执行</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">QString <span class="title">url</span><span class="params">(<span class="string">&quot;http://localhost:8080/api/rest&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [1] GET 请求无参数</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(url).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [2] GET 请求有参数，有自定义 header，有失败的回调函数</span></span><br><span class="line">        <span class="comment">// 提示: 多个参数也可以传入 map: HttpClient(url).params(&#123;&#123;&quot;name&quot;, &quot;诸葛亮&quot;&#125;, &#123;&quot;attackDamage&quot;, &quot;99&quot;&#125;&#125;).get(...);</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(url).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;诸葛亮&quot;</span>).<span class="built_in">param</span>(<span class="string">&quot;value&quot;</span>, <span class="number">99</span>).<span class="built_in">header</span>(<span class="string">&quot;token&quot;</span>, <span class="string">&quot;md5sum&quot;</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">fail</span>([](<span class="keyword">const</span> QString &amp;error, <span class="keyword">int</span> errorCode) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; error &lt;&lt; errorCode;</span><br><span class="line">        &#125;).<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [3] POST 请求，使用 param 添加参数，请求的参数使用 Form 格式</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(url).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;卧龙&quot;</span>).<span class="built_in">param</span>(<span class="string">&quot;value&quot;</span>, <span class="number">99</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">post</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [4] PUT 请求，使用 json 添加参数，请求的参数使用 Json 格式</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(url).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">json</span>(<span class="string">&quot;&#123;\&quot;name\&quot;: \&quot;孔明\&quot;&#125;&quot;</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">put</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [5] DELETE 请求</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(url).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">remove</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// [6] 下载: 保存到文件</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(<span class="string">&quot;http://qtdebug.com/img/dog.png&quot;</span>).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">download</span>(<span class="string">&quot;/Users/Biao/Desktop/dog-1.png&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 上传的同时能够传递参数</span></span><br><span class="line">        <span class="comment">// [7] 上传一个文件</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(<span class="string">&quot;http://localhost:8080/api/upload&quot;</span>).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">upload</span>(<span class="built_in">QString</span>(<span class="string">&quot;/Users/Biao/Pictures/ade.jpg&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [8] 上传多个文件</span></span><br><span class="line">        <span class="built_in">HttpClient</span>(<span class="string">&quot;http://localhost:8080/api/uploads&quot;</span>).<span class="built_in">debug</span>(<span class="literal">true</span>).<span class="built_in">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Biao&quot;</span>).<span class="built_in">success</span>([](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response;</span><br><span class="line">        &#125;).<span class="built_in">upload</span>(&#123; <span class="string">&quot;/Users/Biao/Pictures/ade.jpg&quot;</span>, <span class="string">&quot;/Users/Biao/Pictures/avatar.jpg&quot;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// [9] 共享 QNetworkAccessManager</span></span><br><span class="line">        <span class="comment">// 每创建一个 QNetworkAccessManager 对象都会创建一个线程，当频繁的访问网络时，为了节省线程资源，调用 manager()</span></span><br><span class="line">        <span class="comment">// 使用共享的 QNetworkAccessManager，它不会被 HttpClient 删除，需要我们自己不用的时候删除它。</span></span><br><span class="line">        <span class="comment">// 如果下面的代码不传入 QNetworkAccessManager，从任务管理器里可以看到创建了几千个线程。</span></span><br><span class="line">        QNetworkAccessManager *manager = <span class="keyword">new</span> <span class="built_in">QNetworkAccessManager</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; ++i) &#123;</span><br><span class="line">            <span class="built_in">HttpClient</span>(<span class="string">&quot;http://localhost:8080/api/rest&quot;</span>).<span class="built_in">manager</span>(manager).<span class="built_in">success</span>([=](<span class="keyword">const</span> QString &amp;response) &#123;</span><br><span class="line">                <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; response &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; i;</span><br><span class="line">            &#125;).<span class="built_in">get</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HttpClient-h"><a href="#HttpClient-h" class="headerlink" title="HttpClient.h"></a>HttpClient.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HTTPCLIENT_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HTTPCLIENT_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMap&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QNetworkReply&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QNetworkRequest&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QNetworkAccessManager&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClientPrivate</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对 QNetworkAccessManager 简单封装的 HTTP 访问客户端，简化 GET、POST、PUT、DELETE、上传、下载等操作。</span></span><br><span class="line"><span class="comment"> * 在执行请求前设置需要的参数和回调函数:</span></span><br><span class="line"><span class="comment"> *     1. 调用 header() 设置请求头</span></span><br><span class="line"><span class="comment"> *     2. 调用 param() 设置参数，使用 Form 表单的方式提交请求，GET 请求的 query parameters 也可以用它设置</span></span><br><span class="line"><span class="comment"> *     3. 调用 json() 设置 JSON 字符串的 request body，Content-Type 为 application/json，</span></span><br><span class="line"><span class="comment"> *        当然也可以不是 JSON 格式，因使用 request body 的情况多数是使用 JSON 格式传递复杂对象，故命名为 json</span></span><br><span class="line"><span class="comment"> *     4. 调用 success() 注册请求成功的回调函数</span></span><br><span class="line"><span class="comment"> *     5. 调用 fail() 注册请求失败的回调函数</span></span><br><span class="line"><span class="comment"> *     6. 调用 complete() 注册请求结束的回调函数</span></span><br><span class="line"><span class="comment"> *        success(), fail(), complete() 的回调函数是可选的，根据需要注册对应的回调函数，也可以一个都不注册</span></span><br><span class="line"><span class="comment"> * 然后根据请求的类型调用 get(), post(), put(), remove(), download(), upload() 执行 HTTP 请求</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 默认 HttpClient 会创建一个 QNetworkAccessManager，如果不想使用默认的，调用 manager() 传入即可。</span></span><br><span class="line"><span class="comment"> * 调用 debug(true) 设置为调试模式，输出调试信息如 URL、参数等。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClient</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">HttpClient</span>(<span class="keyword">const</span> QString &amp;url);</span><br><span class="line">    ~<span class="built_in">HttpClient</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 每创建一个 QNetworkAccessManager 对象都会创建一个线程，当频繁的访问网络时，为了节省线程资源，</span></span><br><span class="line"><span class="comment">     *     可以传入 QNetworkAccessManager 给多个请求共享 (它不会被 HttpClient 删除，用户需要自己手动删除)。</span></span><br><span class="line"><span class="comment">     *     如果没有使用 manager() 传入一个 QNetworkAccessManager，则 HttpClient 会自动的创建一个，并且在网络访问完成后自动删除它。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  manager 执行 HTTP 请求的 QNetworkAccessManager 对象</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">manager</span><span class="params">(QNetworkAccessManager *manager)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief  参数 debug 为 true 则使用 debug 模式，请求执行时输出请求的 URL 和参数等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  debug 是否启用调试模式</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">debug</span><span class="params">(<span class="keyword">bool</span> debug)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加一个请求的参数，可以多次调用添加多个参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param name  参数的名字</span></span><br><span class="line"><span class="comment">     * @param value 参数的值</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">param</span><span class="params">(<span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QVariant &amp;value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加多个请求的参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param ps QMap 类型的参数，key 为参数名，value 为参数值</span></span><br><span class="line"><span class="comment">     *           可以使用 &#123;&#123;&quot;name&quot;, 1&#125;, &#123;&quot;box&quot;, 2&#125;&#125; 的方式创建 QMap 对象</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">params</span><span class="params">(<span class="keyword">const</span> QMap&lt;QString, QVariant&gt; &amp;ps)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加请求的参数 (请求体)，使用 Json 格式，例如 &quot;&#123;\&quot;name\&quot;: \&quot;Alice\&quot;&#125;&quot;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param json 请求体 (request body) 为 Json 格式的参数字符串</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">json</span><span class="params">(<span class="keyword">const</span> QString &amp;json)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加请求头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param name  请求头的名字</span></span><br><span class="line"><span class="comment">     * @param value 请求头的值</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">header</span><span class="params">(<span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QString &amp;value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加多个请求头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param nameValues 请求头的名字和值对</span></span><br><span class="line"><span class="comment">     *                   可以使用 &#123;&#123;&quot;name&quot;, 1&#125;, &#123;&quot;box&quot;, 2&#125;&#125; 的方式创建 QMap 对象</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">headers</span><span class="params">(<span class="keyword">const</span> QMap&lt;QString, QString&gt; nameValues)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 注册请求成功的回调函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param successHandler 成功的回调函数，参数为响应的字符串</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">success</span><span class="params">(std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QString &amp;)&gt; successHandler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 注册请求失败的回调函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param failHandler 失败的回调函数，参数为失败原因和 HTTP 状态码</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">fail</span><span class="params">(std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QString &amp;, <span class="keyword">int</span>)&gt; failHandler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 注册请求结束的回调函数，不管成功还是失败请求结束后都会执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param completeHandler 完成的回调函数，无参数</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">complete</span><span class="params">(std::function&lt;<span class="keyword">void</span> ()&gt; completeHandler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 设置请求响应的字符集，默认使用 UTF-8</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param cs 字符集</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClient 的引用，可以用于链式调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClient&amp; <span class="title">charset</span><span class="params">(<span class="keyword">const</span> QString &amp;cs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行 GET 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行 POST 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行 PUT 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行 DELETE 请求，由于 delete 是 C++ 的运算符，所以用同义词 remove</span></span><br><span class="line"><span class="comment">     *        注意: Qt 提供的 DELETE 请求是不支持传递参数的，</span></span><br><span class="line"><span class="comment">     *        请参考 QNetworkAccessManager::deleteResource(const QNetworkRequest &amp;request)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 使用 GET 进行下载，下载的文件保存到 savePath</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param savePath 下载的文件保存路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">download</span><span class="params">(<span class="keyword">const</span> QString &amp;savePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 上传单个文件</span></span><br><span class="line"><span class="comment">     *        使用 POST 上传，服务器端获取文件的参数名为 file</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param path 要上传的文件的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">upload</span><span class="params">(<span class="keyword">const</span> QString &amp;path)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 上传文件，文件的内容已经读取到 data 中</span></span><br><span class="line"><span class="comment">     *        使用 POST 上传，服务器端获取文件的参数名为 file</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param path 要上传的文件的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">upload</span><span class="params">(<span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 上传多个文件</span></span><br><span class="line"><span class="comment">     *        使用 POST 上传，服务器端获取文件的参数名为 files</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param paths 要上传的文件的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">upload</span><span class="params">(<span class="keyword">const</span> QStringList &amp;paths)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HttpClientPrivate *d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HTTPCLIENT_H</span></span></span><br></pre></td></tr></table></figure>

<h2 id="HttpClient-cpp"><a href="#HttpClient-cpp" class="headerlink" title="HttpClient.cpp"></a>HttpClient.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HttpClient.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QFile&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHash&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QUrlQuery&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHttpPart&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHttpMultiPart&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------|</span></span><br><span class="line"><span class="comment"> |                              HttpClientPrivate                              |</span></span><br><span class="line"><span class="comment"> |----------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 请求的类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注: UPLOAD 不是 HTTP Method，只是为了上传时对请求进行特殊处理而定义的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">HttpClientRequestMethod</span> &#123;</span></span><br><span class="line">    GET, POST, PUT, DELETE, UPLOAD</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 缓存 HttpClientPrivate 的数据成员，方便在异步 lambda 中使用 = 以值的方式访问。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClientPrivateCache</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> (<span class="keyword">const</span> QString &amp;)&gt;      successHandler = <span class="literal">nullptr</span>;</span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> (<span class="keyword">const</span> QString &amp;, <span class="keyword">int</span>)&gt;    failHandler = <span class="literal">nullptr</span>;</span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> ()&gt;                    completeHandler = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">bool</span> debug    = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> internal = <span class="literal">false</span>;</span><br><span class="line">    QString charset;</span><br><span class="line">    QNetworkAccessManager* manager = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief HttpClient 的辅助类，封装不希望暴露给客户端的数据和方法，使得 HttpClient 只暴露必要的 API 给客户端。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClientPrivate</span> &#123;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClient</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">HttpClientPrivate</span>(<span class="keyword">const</span> QString &amp;url);</span><br><span class="line">    ~<span class="built_in">HttpClientPrivate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 缓存 HttpClientPrivate 的数据成员</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return 返回 HttpClientPrivateCache 缓存对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HttpClientPrivateCache <span class="title">cache</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取 Manager，如果传入了 manager 则返回此 manager，否则新创建一个 manager，默认会自动创建一个 manager，</span></span><br><span class="line"><span class="comment">     *        使用传入的 manager 则 interval 被设置为 false，自动创建的 manager 则设置 interval 为 true</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return 返回 QNetworkAccessManager 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">QNetworkAccessManager* <span class="title">getManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 使用用户设定的 URL、请求头、参数等创建 Request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param d      HttpClientPrivate 的对象</span></span><br><span class="line"><span class="comment">     * @param method 请求的类型</span></span><br><span class="line"><span class="comment">     * @return 返回可用于执行请求的 QNetworkRequest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> QNetworkRequest <span class="title">createRequest</span><span class="params">(HttpClientPrivate *d, HttpClientRequestMethod method)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行请求的辅助函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param d      HttpClientPrivate 的对象</span></span><br><span class="line"><span class="comment">     * @param method 请求的类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeQuery</span><span class="params">(HttpClientPrivate *d, HttpClientRequestMethod method)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 上传文件或者数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param d     HttpClientPrivate 的对象</span></span><br><span class="line"><span class="comment">     * @param paths 要上传的文件的路径(path 和 data 不能同时使用)</span></span><br><span class="line"><span class="comment">     * @param data  要上传的文件的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">upload</span><span class="params">(HttpClientPrivate *d, <span class="keyword">const</span> QStringList &amp;paths, <span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 使用 GET 进行下载，下载的文件保存到 savePath</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param d        HttpClientPrivate 的对象</span></span><br><span class="line"><span class="comment">     * @param savePath 下载的文件保存路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(HttpClientPrivate *d, <span class="keyword">const</span> QString &amp;savePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 使用 GET 进行下载，当有数据可读取时回调 readyRead(), 大多数情况下应该在 readyRead() 里把数据保存到文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param readyRead 有数据可读取时的回调 lambda 函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(HttpClientPrivate *d, std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QByteArray &amp;)&gt; readyRead)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 读取服务器响应的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param reply   请求的 QNetworkReply 对象</span></span><br><span class="line"><span class="comment">     * @param charset 请求响应的字符集，默认使用 UTF-8</span></span><br><span class="line"><span class="comment">     * @return 返回服务器端响应的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> QString <span class="title">readReply</span><span class="params">(QNetworkReply *reply, <span class="keyword">const</span> QString &amp;charset = <span class="string">&quot;UTF-8&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 请求结束的处理函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param cache          HttpClientPrivateCache 缓存对象</span></span><br><span class="line"><span class="comment">     * @param reply          QNetworkReply 对象，不能为 NULL</span></span><br><span class="line"><span class="comment">     * @param successMessage 请求成功的消息</span></span><br><span class="line"><span class="comment">     * @param failMessage    请求失败的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleFinish</span><span class="params">(HttpClientPrivateCache cache, QNetworkReply *reply, <span class="keyword">const</span> QString &amp;successMessage, <span class="keyword">const</span> QString &amp;failMessage)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/////////////////////////////////////////////////// 成员变量 //////////////////////////////////////////////</span></span><br><span class="line">    QString   url;                            <span class="comment">// 请求的 URL</span></span><br><span class="line">    QString   json;                           <span class="comment">// 请求的参数使用 Json 格式</span></span><br><span class="line">    QUrlQuery params;                         <span class="comment">// 请求的参数使用 Form 格式</span></span><br><span class="line">    QString   charset = <span class="string">&quot;UTF-8&quot;</span>;              <span class="comment">// 请求响应的字符集</span></span><br><span class="line">    QHash&lt;QString, QString&gt; headers;          <span class="comment">// 请求头</span></span><br><span class="line">    QNetworkAccessManager *manager = <span class="literal">nullptr</span>; <span class="comment">// 执行 HTTP 请求的 QNetworkAccessManager 对象</span></span><br><span class="line">    <span class="keyword">bool</span> useJson  = <span class="literal">false</span>;                    <span class="comment">// 为 true 时请求使用 Json 格式传递参数，否则使用 Form 格式传递参数</span></span><br><span class="line">    <span class="keyword">bool</span> debug    = <span class="literal">false</span>;                    <span class="comment">// 为 true 时输出请求的 URL 和参数</span></span><br><span class="line">    <span class="keyword">bool</span> internal = <span class="literal">true</span>;                     <span class="comment">// 是否使用自动创建的 manager</span></span><br><span class="line"></span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> (<span class="keyword">const</span> QString &amp;)&gt;   successHandler = <span class="literal">nullptr</span>; <span class="comment">// 成功的回调函数，参数为响应的字符串</span></span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> (<span class="keyword">const</span> QString &amp;, <span class="keyword">int</span>)&gt; failHandler = <span class="literal">nullptr</span>; <span class="comment">// 失败的回调函数，参数为失败原因和 HTTP status code</span></span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> ()&gt;                 completeHandler = <span class="literal">nullptr</span>; <span class="comment">// 结束的回调函数，无参数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">HttpClientPrivate::<span class="built_in">HttpClientPrivate</span>(<span class="keyword">const</span> QString &amp;url) : <span class="built_in">url</span>(url) &#123; &#125;</span><br><span class="line"></span><br><span class="line">HttpClientPrivate::~<span class="built_in">HttpClientPrivate</span>() &#123;</span><br><span class="line">    manager         = <span class="literal">nullptr</span>;</span><br><span class="line">    successHandler  = <span class="literal">nullptr</span>;</span><br><span class="line">    failHandler     = <span class="literal">nullptr</span>;</span><br><span class="line">    completeHandler = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存 HttpClientPrivate 的数据成员</span></span><br><span class="line"><span class="function">HttpClientPrivateCache <span class="title">HttpClientPrivate::cache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientPrivateCache cache;</span><br><span class="line"></span><br><span class="line">    cache.successHandler  = successHandler;</span><br><span class="line">    cache.failHandler     = failHandler;</span><br><span class="line">    cache.completeHandler = completeHandler;</span><br><span class="line">    cache.debug    = debug;</span><br><span class="line">    cache.internal = internal;</span><br><span class="line">    cache.charset  = charset;</span><br><span class="line">    cache.manager  = <span class="built_in">getManager</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行请求的辅助函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClientPrivate::executeQuery</span><span class="params">(HttpClientPrivate *d, HttpClientRequestMethod method)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 缓存需要的变量，在 lambda 中使用 = 捕获进行值传递 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    <span class="comment">// 2. 创建请求需要的变量</span></span><br><span class="line">    <span class="comment">// 3. 根据 method 执行不同的请求</span></span><br><span class="line">    <span class="comment">// 4. 请求结束时获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 缓存需要的变量，在 lambda 中使用 = 捕获进行值传递 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    HttpClientPrivateCache cache = d-&gt;<span class="built_in">cache</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 创建请求需要的变量</span></span><br><span class="line">    QNetworkRequest request = HttpClientPrivate::<span class="built_in">createRequest</span>(d, method);</span><br><span class="line">    QNetworkReply    *reply = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 根据 method 执行不同的请求</span></span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (method) &#123;</span><br><span class="line">    <span class="keyword">case</span> HttpClientRequestMethod::GET:</span><br><span class="line">        reply = cache.manager-&gt;<span class="built_in">get</span>(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HttpClientRequestMethod::POST:</span><br><span class="line">        reply = cache.manager-&gt;<span class="built_in">post</span>(request, d-&gt;useJson ? d-&gt;json.<span class="built_in">toUtf8</span>() : d-&gt;params.<span class="built_in">toString</span>(QUrl::FullyEncoded).<span class="built_in">toUtf8</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HttpClientRequestMethod::PUT:</span><br><span class="line">        reply = cache.manager-&gt;<span class="built_in">put</span>(request, d-&gt;useJson ? d-&gt;json.<span class="built_in">toUtf8</span>() : d-&gt;params.<span class="built_in">toString</span>(QUrl::FullyEncoded).<span class="built_in">toUtf8</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HttpClientRequestMethod::DELETE:</span><br><span class="line">        reply = cache.manager-&gt;<span class="built_in">deleteResource</span>(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 请求结束时获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line">    <span class="comment">// 请求结束时一次性读取所有响应数据</span></span><br><span class="line">    QObject::<span class="built_in">connect</span>(reply, &amp;QNetworkReply::finished, [=] &#123;</span><br><span class="line">        QString successMessage = HttpClientPrivate::<span class="built_in">readReply</span>(reply, cache.charset.<span class="built_in">toUtf8</span>());</span><br><span class="line">        QString failMessage    = reply-&gt;<span class="built_in">errorString</span>();</span><br><span class="line">        HttpClientPrivate::<span class="built_in">handleFinish</span>(cache, reply, successMessage, failMessage);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 GET 进行下载，下载的文件保存到 savePath</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClientPrivate::download</span><span class="params">(HttpClientPrivate *d, <span class="keyword">const</span> QString &amp;savePath)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 打开下载文件，如果打开文件出错，不进行下载</span></span><br><span class="line">    <span class="comment">// 2. 给请求结束的回调函数注入关闭释放文件的行为</span></span><br><span class="line">    <span class="comment">// 3. 调用下载的重载函数开始下载</span></span><br><span class="line">    QFile *file = <span class="keyword">new</span> <span class="built_in">QFile</span>(savePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 打开下载文件，如果打开文件出错，不进行下载</span></span><br><span class="line">    <span class="keyword">if</span> (!file-&gt;<span class="built_in">open</span>(QIODevice::WriteOnly | QIODevice::Truncate)) &#123;</span><br><span class="line">        file-&gt;<span class="built_in">close</span>();</span><br><span class="line">        file-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (d-&gt;debug) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; <span class="built_in">QString</span>(<span class="string">&quot;[错误] 打开文件出错: %1&quot;</span>).<span class="built_in">arg</span>(savePath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">nullptr</span> != d-&gt;failHandler) &#123;</span><br><span class="line">            d-&gt;<span class="built_in">failHandler</span>(<span class="built_in">QString</span>(<span class="string">&quot;[错误] 打开文件出错: %1&quot;</span>).<span class="built_in">arg</span>(savePath), <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 给请求结束的回调函数注入关闭释放文件的行为</span></span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> ()&gt; userCompleteHandler     = d-&gt;completeHandler;</span><br><span class="line">    std::function&lt;<span class="built_in"><span class="keyword">void</span></span> ()&gt; injectedCompleteHandler = [=]() &#123;</span><br><span class="line">        <span class="comment">// 请求结束后释放文件对象</span></span><br><span class="line">        file-&gt;<span class="built_in">flush</span>();</span><br><span class="line">        file-&gt;<span class="built_in">close</span>();</span><br><span class="line">        file-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行用户指定的结束回调函数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">nullptr</span> != userCompleteHandler) &#123;</span><br><span class="line">            <span class="built_in">userCompleteHandler</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    d-&gt;completeHandler = injectedCompleteHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 调用下载的重载函数开始下载</span></span><br><span class="line">    HttpClientPrivate::<span class="built_in">download</span>(d, [=](<span class="keyword">const</span> QByteArray &amp;data) &#123;</span><br><span class="line">        file-&gt;<span class="built_in">write</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 GET 进行下载，当有数据可读取时回调 readyRead(), 大多数情况下应该在 readyRead() 里把数据保存到文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClientPrivate::download</span><span class="params">(HttpClientPrivate *d, std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QByteArray &amp;)&gt; readyRead)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 缓存需要的变量，在 lambda 中使用 = 捕获进行值传递 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    <span class="comment">// 2. 创建请求需要的变量，执行请求</span></span><br><span class="line">    <span class="comment">// 3. 有数据可读取时回调 readyRead()</span></span><br><span class="line">    <span class="comment">// 4. 请求结束时获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 缓存需要的变量，在 lambda 中使用 = 捕捉使用 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    HttpClientPrivateCache cache = d-&gt;<span class="built_in">cache</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 创建请求需要的变量，执行请求</span></span><br><span class="line">    QNetworkRequest request = HttpClientPrivate::<span class="built_in">createRequest</span>(d, HttpClientRequestMethod::GET);</span><br><span class="line">    QNetworkReply    *reply = cache.manager-&gt;<span class="built_in">get</span>(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 有数据可读取时回调 readyRead()</span></span><br><span class="line">    QObject::<span class="built_in">connect</span>(reply, &amp;QNetworkReply::readyRead, [=] &#123;</span><br><span class="line">        <span class="built_in">readyRead</span>(reply-&gt;<span class="built_in">readAll</span>());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 请求结束时获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line">    QObject::<span class="built_in">connect</span>(reply, &amp;QNetworkReply::finished, [=] &#123;</span><br><span class="line">        QString successMessage = <span class="string">&quot;下载完成&quot;</span>; <span class="comment">// 请求结束时一次性读取所有响应数据</span></span><br><span class="line">        QString failMessage    = reply-&gt;<span class="built_in">errorString</span>();</span><br><span class="line">        HttpClientPrivate::<span class="built_in">handleFinish</span>(cache, reply, successMessage, failMessage);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件或者数据的实现</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClientPrivate::upload</span><span class="params">(HttpClientPrivate *d, <span class="keyword">const</span> QStringList &amp;paths, <span class="keyword">const</span> QByteArray &amp;data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 缓存需要的变量，在 lambda 中使用 = 捕获进行值传递 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    <span class="comment">// 2. 创建 Form 表单的参数 Text Part</span></span><br><span class="line">    <span class="comment">// 3. 创建上传的 File Part</span></span><br><span class="line">    <span class="comment">//    3.1 使用文件创建 File Part</span></span><br><span class="line">    <span class="comment">//    3.2 使用数据创建 File Part</span></span><br><span class="line">    <span class="comment">// 4. 创建请求需要的变量，执行请求</span></span><br><span class="line">    <span class="comment">// 5. 请求结束时释放 multiPart 和打开的文件，获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 缓存需要的变量，在 lambda 中使用 = 捕捉使用 (不能使用引用 &amp;，因为 d 已经被析构)</span></span><br><span class="line">    HttpClientPrivateCache cache = d-&gt;<span class="built_in">cache</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 创建 Form 表单的参数 Text Part</span></span><br><span class="line">    QHttpMultiPart *multiPart = <span class="keyword">new</span> <span class="built_in">QHttpMultiPart</span>(QHttpMultiPart::FormDataType);</span><br><span class="line">    QList&lt;QPair&lt;QString, QString&gt; &gt; paramItems = d-&gt;params.<span class="built_in">queryItems</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramItems.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        QString name  = paramItems.<span class="built_in">at</span>(i).first;</span><br><span class="line">        QString value = paramItems.<span class="built_in">at</span>(i).second;</span><br><span class="line"></span><br><span class="line">        QHttpPart textPart;</span><br><span class="line">        textPart.<span class="built_in">setHeader</span>(QNetworkRequest::ContentDispositionHeader, <span class="built_in">QString</span>(<span class="string">&quot;form-data; name=\&quot;%1\&quot;&quot;</span>).<span class="built_in">arg</span>(name));</span><br><span class="line">        textPart.<span class="built_in">setBody</span>(value.<span class="built_in">toUtf8</span>());</span><br><span class="line">        multiPart-&gt;<span class="built_in">append</span>(textPart);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (paths.<span class="built_in">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// [3.1] 使用文件创建 File Part</span></span><br><span class="line">        QString inputName = paths.<span class="built_in">size</span>() == <span class="number">1</span> ? <span class="string">&quot;file&quot;</span> : <span class="string">&quot;files&quot;</span>; <span class="comment">// 一个文件时为 file，多个文件时为 files</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> QString &amp;path : paths) &#123;</span><br><span class="line">            <span class="comment">// path 为空时，不上传文件</span></span><br><span class="line">            <span class="keyword">if</span> (path.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We cannot delete the file now, so delete it with the multiPart</span></span><br><span class="line">            QFile *file = <span class="keyword">new</span> <span class="built_in">QFile</span>(path, multiPart);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果文件打开失败，则释放资源返回，终止上传</span></span><br><span class="line">            <span class="keyword">if</span>(!file-&gt;<span class="built_in">open</span>(QIODevice::ReadOnly)) &#123;</span><br><span class="line">                QString failMessage = <span class="built_in">QString</span>(<span class="string">&quot;打开文件失败[%2]: %1&quot;</span>).<span class="built_in">arg</span>(path).<span class="built_in">arg</span>(file-&gt;<span class="built_in">errorString</span>());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cache.debug) &#123;</span><br><span class="line">                    <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; failMessage;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">nullptr</span> != cache.failHandler) &#123;</span><br><span class="line">                    cache.<span class="built_in">failHandler</span>(failMessage, <span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                multiPart-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 单个文件时，name 为服务器端获取文件的参数名，为 file</span></span><br><span class="line">            <span class="comment">// 多个文件时，name 为服务器端获取文件的参数名，为 files</span></span><br><span class="line">            <span class="comment">// 注意: 服务器是 Java 的则用 form-data</span></span><br><span class="line">            <span class="comment">// 注意: 服务器是 PHP  的则用 multipart/form-data</span></span><br><span class="line">            QString disposition = <span class="built_in">QString</span>(<span class="string">&quot;form-data; name=\&quot;%1\&quot;; filename=\&quot;%2\&quot;&quot;</span>).<span class="built_in">arg</span>(inputName).<span class="built_in">arg</span>(file-&gt;<span class="built_in">fileName</span>());</span><br><span class="line">            QHttpPart filePart;</span><br><span class="line">            filePart.<span class="built_in">setHeader</span>(QNetworkRequest::ContentDispositionHeader, <span class="built_in">QVariant</span>(disposition));</span><br><span class="line">            filePart.<span class="built_in">setBodyDevice</span>(file);</span><br><span class="line">            multiPart-&gt;<span class="built_in">append</span>(filePart);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// [3.2] 使用数据创建 File Part</span></span><br><span class="line">        QString   disposition = <span class="built_in">QString</span>(<span class="string">&quot;form-data; name=\&quot;file\&quot;; filename=\&quot;no-name\&quot;&quot;</span>);</span><br><span class="line">        QHttpPart dataPart;</span><br><span class="line">        dataPart.<span class="built_in">setHeader</span>(QNetworkRequest::ContentDispositionHeader, <span class="built_in">QVariant</span>(disposition));</span><br><span class="line">        dataPart.<span class="built_in">setBody</span>(data);</span><br><span class="line">        multiPart-&gt;<span class="built_in">append</span>(dataPart);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 创建请求需要的变量，执行请求</span></span><br><span class="line">    QNetworkRequest request = HttpClientPrivate::<span class="built_in">createRequest</span>(d, HttpClientRequestMethod::UPLOAD);</span><br><span class="line">    QNetworkReply    *reply = cache.manager-&gt;<span class="built_in">post</span>(request, multiPart);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [5] 请求结束时释放 multiPart 和文件，获取响应数据，在 handleFinish 中执行回调函数</span></span><br><span class="line">    QObject::<span class="built_in">connect</span>(reply, &amp;QNetworkReply::finished, [=] &#123;</span><br><span class="line">        multiPart-&gt;<span class="built_in">deleteLater</span>(); <span class="comment">// 释放资源: multiPart + file</span></span><br><span class="line"></span><br><span class="line">        QString successMessage = HttpClientPrivate::<span class="built_in">readReply</span>(reply, cache.charset); <span class="comment">// 请求结束时一次性读取所有响应数据</span></span><br><span class="line">        QString failMessage    = reply-&gt;<span class="built_in">errorString</span>();</span><br><span class="line">        HttpClientPrivate::<span class="built_in">handleFinish</span>(cache, reply, successMessage, failMessage);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 Manager，如果传入了 manager 则返回此 manager，否则新创建一个 manager，默认会自动创建一个 manager</span></span><br><span class="line"><span class="function">QNetworkAccessManager* <span class="title">HttpClientPrivate::getManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> internal ? <span class="keyword">new</span> <span class="built_in">QNetworkAccessManager</span>() : manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用用户设定的 URL、请求头、参数等创建 Request</span></span><br><span class="line"><span class="function">QNetworkRequest <span class="title">HttpClientPrivate::createRequest</span><span class="params">(HttpClientPrivate *d, HttpClientRequestMethod method)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 如果是 GET 请求，并且参数不为空，则编码请求的参数，放到 URL 后面</span></span><br><span class="line">    <span class="comment">// 2. 调试时输出网址和参数</span></span><br><span class="line">    <span class="comment">// 3. 设置 Content-Type</span></span><br><span class="line">    <span class="comment">// 4. 添加请求头到 request 中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> get      = method == HttpClientRequestMethod::GET;</span><br><span class="line">    <span class="keyword">bool</span> upload   = method == HttpClientRequestMethod::UPLOAD;</span><br><span class="line">    <span class="keyword">bool</span> withForm = !get &amp;&amp; !upload &amp;&amp; !d-&gt;useJson; <span class="comment">// PUT、POST 或者 DELETE 请求，且 useJson 为 false</span></span><br><span class="line">    <span class="keyword">bool</span> withJson = !get &amp;&amp; !upload &amp;&amp;  d-&gt;useJson; <span class="comment">// PUT、POST 或者 DELETE 请求，且 useJson 为 true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 如果是 GET 请求，并且参数不为空，则编码请求的参数，放到 URL 后面</span></span><br><span class="line">    <span class="keyword">if</span> (get &amp;&amp; !d-&gt;params.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        d-&gt;url += <span class="string">&quot;?&quot;</span> + d-&gt;params.<span class="built_in">toString</span>(QUrl::FullyEncoded);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 调试时输出网址和参数</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;debug) &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; <span class="string">&quot;[网址]&quot;</span> &lt;&lt; d-&gt;url;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (withJson) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; <span class="string">&quot;[参数]&quot;</span> &lt;&lt; d-&gt;json;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (withForm || upload) &#123;</span><br><span class="line">            QList&lt;QPair&lt;QString, QString&gt; &gt; paramItems = d-&gt;params.<span class="built_in">queryItems</span>();</span><br><span class="line">            QString buffer; <span class="comment">// 避免多次调用 qDebug() 输入调试信息，每次 qDebug() 都有可能输出行号等</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 按键值对的方式输出参数</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramItems.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">                QString name  = paramItems.<span class="built_in">at</span>(i).first;</span><br><span class="line">                QString value = paramItems.<span class="built_in">at</span>(i).second;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</span><br><span class="line">                    buffer += <span class="built_in">QString</span>(<span class="string">&quot;[参数] %1=%2\n&quot;</span>).<span class="built_in">arg</span>(name).<span class="built_in">arg</span>(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    buffer += <span class="built_in">QString</span>(<span class="string">&quot;       %1=%2\n&quot;</span>).<span class="built_in">arg</span>(name).<span class="built_in">arg</span>(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!buffer.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">                <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; buffer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 设置 Content-Type</span></span><br><span class="line">    <span class="comment">// 如果是 POST 请求，useJson 为 true 时添加 Json 的请求头，useJson 为 false 时添加 Form 的请求头</span></span><br><span class="line">    <span class="keyword">if</span> (withForm) &#123;</span><br><span class="line">        d-&gt;headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (withJson) &#123;</span><br><span class="line">        d-&gt;headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json; charset=utf-8&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 添加请求头到 request 中</span></span><br><span class="line">    <span class="function">QNetworkRequest <span class="title">request</span><span class="params">(QUrl(d-&gt;url))</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i = d-&gt;headers.<span class="built_in">cbegin</span>(); i != d-&gt;headers.<span class="built_in">cend</span>(); ++i) &#123;</span><br><span class="line">        request.<span class="built_in">setRawHeader</span>(i.<span class="built_in">key</span>().<span class="built_in">toUtf8</span>(), i.<span class="built_in">value</span>().<span class="built_in">toUtf8</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取服务器响应的数据</span></span><br><span class="line"><span class="function">QString <span class="title">HttpClientPrivate::readReply</span><span class="params">(QNetworkReply *reply, <span class="keyword">const</span> QString &amp;charset)</span> </span>&#123;</span><br><span class="line">    <span class="function">QTextStream <span class="title">in</span><span class="params">(reply)</span></span>;</span><br><span class="line">    QString result;</span><br><span class="line">    in.<span class="built_in">setCodec</span>(charset.<span class="built_in">toUtf8</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!in.<span class="built_in">atEnd</span>()) &#123;</span><br><span class="line">        result += in.<span class="built_in">readLine</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求结束的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClientPrivate::handleFinish</span><span class="params">(HttpClientPrivateCache cache, QNetworkReply *reply, <span class="keyword">const</span> QString &amp;successMessage, <span class="keyword">const</span> QString &amp;failMessage)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 执行请求成功的回调函数</span></span><br><span class="line">    <span class="comment">// 2. 执行请求失败的回调函数</span></span><br><span class="line">    <span class="comment">// 3. 执行请求结束的回调函数</span></span><br><span class="line">    <span class="comment">// 4. 释放 reply 和 manager 对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply-&gt;<span class="built_in">error</span>() == QNetworkReply::NoError) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.debug) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; <span class="built_in">QString</span>(<span class="string">&quot;[结束] 成功: %1&quot;</span>).<span class="built_in">arg</span>(successMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [1] 执行请求成功的回调函数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">nullptr</span> != cache.successHandler) &#123;</span><br><span class="line">            cache.<span class="built_in">successHandler</span>(successMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.debug) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>().<span class="built_in">noquote</span>() &lt;&lt; <span class="built_in">QString</span>(<span class="string">&quot;[结束] 失败: %1&quot;</span>).<span class="built_in">arg</span>(failMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [2] 执行请求失败的回调函数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">nullptr</span> != cache.failHandler) &#123;</span><br><span class="line">            cache.<span class="built_in">failHandler</span>(failMessage, reply-&gt;<span class="built_in">error</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 执行请求结束的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> != cache.completeHandler) &#123;</span><br><span class="line">        cache.<span class="built_in">completeHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 释放 reply 和 manager 对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> != reply) &#123;</span><br><span class="line">        reply-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache.internal &amp;&amp; <span class="literal">nullptr</span> != cache.manager) &#123;</span><br><span class="line">        cache.manager-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------|</span></span><br><span class="line"><span class="comment"> |                                 HttpClient                                  |</span></span><br><span class="line"><span class="comment"> |----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意: 在异步请求中 HttpClient 的 HttpClientPrivate 成员变量 d 已经被析构，所以需要先缓存相关变量为栈对象，使用 = 以值的方式访问</span></span><br><span class="line">HttpClient::<span class="built_in">HttpClient</span>(<span class="keyword">const</span> QString &amp;url) : <span class="built_in">d</span>(<span class="keyword">new</span> <span class="built_in">HttpClientPrivate</span>(url)) &#123; &#125;</span><br><span class="line"></span><br><span class="line">HttpClient::~<span class="built_in">HttpClient</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入 QNetworkAccessManager 给多个请求共享</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::manager</span><span class="params">(QNetworkAccessManager *manager)</span> </span>&#123;</span><br><span class="line">    d-&gt;manager  = manager;</span><br><span class="line">    d-&gt;internal = (<span class="literal">nullptr</span> == manager);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入 debug 为 true 则使用 debug 模式，请求执行时输出请求的 URL 和参数等</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::debug</span><span class="params">(<span class="keyword">bool</span> debug)</span> </span>&#123;</span><br><span class="line">    d-&gt;debug = debug;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个请求的参数，可以多次调用添加多个参数</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::param</span><span class="params">(<span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QVariant &amp;value)</span> </span>&#123;</span><br><span class="line">    d-&gt;params.<span class="built_in">addQueryItem</span>(name, value.<span class="built_in">toString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加多个请求的参数</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::params</span><span class="params">(<span class="keyword">const</span> QMap&lt;QString, QVariant&gt; &amp;ps)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> iter = ps.<span class="built_in">cbegin</span>(); iter != ps.<span class="built_in">cend</span>(); ++iter) &#123;</span><br><span class="line">        d-&gt;params.<span class="built_in">addQueryItem</span>(iter.<span class="built_in">key</span>(), iter.<span class="built_in">value</span>().<span class="built_in">toString</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求的参数 (请求体)，使用 Json 格式，例如 &quot;&#123;\&quot;name\&quot;: \&quot;Alice\&quot;&#125;&quot;</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::json</span><span class="params">(<span class="keyword">const</span> QString &amp;json)</span> </span>&#123;</span><br><span class="line">    d-&gt;json    = json;</span><br><span class="line">    d-&gt;useJson = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求头</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::header</span><span class="params">(<span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QString &amp;value)</span> </span>&#123;</span><br><span class="line">    d-&gt;headers[name] = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加多个请求头</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::headers</span><span class="params">(<span class="keyword">const</span> QMap&lt;QString, QString&gt; nameValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i = nameValues.<span class="built_in">cbegin</span>(); i != nameValues.<span class="built_in">cend</span>(); ++i) &#123;</span><br><span class="line">        d-&gt;headers[i.<span class="built_in">key</span>()] = i.<span class="built_in">value</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册请求成功的回调函数</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::success</span><span class="params">(std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QString &amp;)&gt; successHandler)</span> </span>&#123;</span><br><span class="line">    d-&gt;successHandler = successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册请求失败的回调函数</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::fail</span><span class="params">(std::function&lt;<span class="keyword">void</span> (<span class="keyword">const</span> QString &amp;, <span class="keyword">int</span>)&gt; failHandler)</span> </span>&#123;</span><br><span class="line">    d-&gt;failHandler = failHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册请求结束的回调函数，不管成功还是失败都会执行</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::complete</span><span class="params">(std::function&lt;<span class="keyword">void</span> ()&gt; completeHandler)</span> </span>&#123;</span><br><span class="line">    d-&gt;completeHandler = completeHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置请求响应的编码</span></span><br><span class="line"><span class="function">HttpClient&amp; <span class="title">HttpClient::charset</span><span class="params">(<span class="keyword">const</span> QString &amp;cs)</span> </span>&#123;</span><br><span class="line">    d-&gt;charset = cs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 GET 请求</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">executeQuery</span>(d, HttpClientRequestMethod::GET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 POST 请求</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::post</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">executeQuery</span>(d, HttpClientRequestMethod::POST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 PUT 请求</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::put</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">executeQuery</span>(d, HttpClientRequestMethod::PUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 DELETE 请求</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">executeQuery</span>(d, HttpClientRequestMethod::DELETE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 GET 进行下载，下载的文件保存到 savePath</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::download</span><span class="params">(<span class="keyword">const</span> QString &amp;savePath)</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">download</span>(d, savePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::upload</span><span class="params">(<span class="keyword">const</span> QString &amp;path)</span> </span>&#123;</span><br><span class="line">    QStringList paths = &#123; path &#125;;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">upload</span>(d, paths, <span class="built_in">QByteArray</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件，文件的内容以及读取到 data 中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::upload</span><span class="params">(<span class="keyword">const</span> QByteArray &amp;data)</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">upload</span>(d, <span class="built_in">QStringList</span>(), data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传多个文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HttpClient::upload</span><span class="params">(<span class="keyword">const</span> QStringList &amp;paths)</span> </span>&#123;</span><br><span class="line">    HttpClientPrivate::<span class="built_in">upload</span>(d, paths, <span class="built_in">QByteArray</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务器端处理请求的代码"><a href="#服务器端处理请求的代码" class="headerlink" title="服务器端处理请求的代码"></a>服务器端处理请求的代码</h2><p>这里的服务器端处理请求的代码使用了 <code>SpringMVC</code> 实现，作为参考，可以使用其他语言实现，例如 PHP，C#。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xtuer.bean.Result;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/rest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/rest&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">restGet</span><span class="params">(<span class="meta">@RequestParam(required = false, defaultValue = &quot;Alice&quot;)</span> String name,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        map.put(<span class="string">&quot;attackDamage&quot;</span>, value + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/rest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/rest&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">restPost</span><span class="params">(<span class="meta">@RequestParam(required = false, defaultValue = &quot;Alice&quot;)</span> String name,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        map.put(<span class="string">&quot;attackDamage&quot;</span>, value + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;POST&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/rest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/api/rest&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">restPut</span><span class="params">(<span class="meta">@RequestBody</span> String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/rest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/api/rest&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">restDelete</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;DELETE&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/upload&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">uploadFile</span><span class="params">(<span class="meta">@RequestParam</span> MultipartFile file,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="meta">@RequestParam(required = false, defaultValue = &quot;Alice&quot;)</span> String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FileUtils.copyInputStreamToFile(file.getInputStream(), <span class="keyword">new</span> File(<span class="string">&quot;/Users/Biao/Desktop/&quot;</span> + file.getOriginalFilename()));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        map.put(<span class="string">&quot;filename&quot;</span>, file.getOriginalFilename());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/uploads&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">uploadFiles</span><span class="params">(<span class="meta">@RequestParam(name = &quot;files&quot;)</span> List&lt;MultipartFile&gt; files,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="meta">@RequestParam(required = false, defaultValue = &quot;Alice&quot;)</span> String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;String&gt; filenames = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile file : files) &#123;</span><br><span class="line">            FileUtils.copyInputStreamToFile(file.getInputStream(), <span class="keyword">new</span> File(<span class="string">&quot;/Users/Biao/Desktop/&quot;</span> + file.getOriginalFilename()));</span><br><span class="line">            filenames.add(file.getOriginalFilename());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        map.put(<span class="string">&quot;filenames&quot;</span>, filenames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-HTTPS"><a href="#使用-HTTPS" class="headerlink" title="使用 HTTPS"></a>使用 HTTPS</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">HttpClient</span>(<span class="string">&quot;https://jk.edu-edu.com/initializeRoom&quot;</span>).<span class="built_in">get</span>();</span><br></pre></td></tr></table></figure>

<p>如上访问 https 的网址时控制台输出如下错误信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qt.network.ssl: QSslSocket: cannot call unresolved function SSLv23_client_method</span><br><span class="line">qt.network.ssl: QSslSocket: cannot call unresolved function SSL_CTX_new</span><br><span class="line">qt.network.ssl: QSslSocket: cannot call unresolved function SSL_library_init</span><br><span class="line">qt.network.ssl: QSslSocket: cannot call unresolved function ERR_get_error</span><br><span class="line">qt.network.ssl: QSslSocket: cannot call unresolved function ERR_get_error</span><br></pre></td></tr></table></figure>

<p>解决这个问题只要复制 <code>libeay32.dll</code> 和 <code>ssleay32.dll</code> 到编译出来的 exe 文件所在目录即可。</p>
<p>但是去哪里找这 2 个文件呢？</p>
<ul>
<li><p>如果安装的是 MinGW 的 Qt，那么在 Qt 安装目录的 <code>&lt;Qt&gt;/Tools/mingw530_32/opt/bin</code> 文件夹下能找到它们</p>
</li>
<li><p>下载 <a target="_blank" rel="noopener" href="https://www.openssl.org/">OpenSSL</a> 源码自己编译</p>
</li>
<li><p>安装如 MongoDB，Git 等，他们都带有这 2 个文件</p>
</li>
</ul>

        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/qt-logger/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Qt 自定义日志工具
        
      </div>
    </a>
  
  
    <a href="/qt-access-network/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Qt 访问网络</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

<script>
  if (window.mermaid) {
    mermaid.initialize({
		securityLevel: 'loose',
		theme: 'dark',
	});
  }
</script>

    </div>
</body>

</html>
