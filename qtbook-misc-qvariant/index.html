<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>自定义类型与 QVariant | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="QVariant 非常重要，可以存储很多种不同的类型，例如 int, QString, QRect, QPoint 等，其构造函数有很多个，参数是很多种不同的常用类型，还内置了可以直接转换 QVaraint 到某些类型的函数，如 toInt(), toString(), toPoint(), toSize() 等，还是 QObject 动态 property 机制的关键，除了支持内置的类型外，QV">
<meta property="og:type" content="article">
<meta property="og:title" content="自定义类型与 QVariant">
<meta property="og:url" content="http://xtuer.github.io/qtbook-misc-qvariant/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="QVariant 非常重要，可以存储很多种不同的类型，例如 int, QString, QRect, QPoint 等，其构造函数有很多个，参数是很多种不同的常用类型，还内置了可以直接转换 QVaraint 到某些类型的函数，如 toInt(), toString(), toPoint(), toSize() 等，还是 QObject 动态 property 机制的关键，除了支持内置的类型外，QV">
<meta property="og:locale">
<meta property="article:published_time" content="2017-03-18T03:18:33.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.174Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="QtBook">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/">公孙二狗</a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		<p class="header-subtitle">大圣，此去欲何？踏南天，碎凌霄。若一去不回……？便一去不回！</p>
		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10.59px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 12.35px;">Cas</a> <a href="/tags/DB/" style="font-size: 15.29px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 14.12px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 12.35px;">Hexo</a> <a href="/tags/Index/" style="font-size: 12.94px;">Index</a> <a href="/tags/Java/" style="font-size: 19.41px;">Java</a> <a href="/tags/Mac/" style="font-size: 17.65px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.06px;">Misc</a> <a href="/tags/PHP/" style="font-size: 11.18px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.24px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.82px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 11.18px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 14.12px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.76px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.53px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 15.88px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 14.71px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 15.29px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 17.06px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 17.06px;">Util</a> <a href="/tags/Vue/" style="font-size: 16.47px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.76px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E5%92%8C-QVariant-%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2"><span class="toc-text">自定义类型和 QVariant 互相转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%A7%BD%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B"><span class="toc-text">信号槽中使用自定义类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QObject-property-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B"><span class="toc-text">QObject property 中使用自定义类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QDataStream-%E5%BA%8F%E5%88%97%E5%8C%96%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E7%9A%84-QVariant"><span class="toc-text">QDataStream 序列化自定义类型的 QVariant</span></a></li></ol>
            </div>
        </div>
    </div>


<article id="post-qtbook-misc-qvariant" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/qtbook-misc-qvariant/" class="article-date">
  	<!-- <time datetime="2017-03-18T03:18:33.000Z" itemprop="datePublished">2017-03-18</time> -->
    2017-03-18
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      自定义类型与 QVariant
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QtBook/" rel="tag">QtBook</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p><strong>QVariant</strong> 非常重要，可以存储很多种不同的类型，例如 <strong>int, QString, QRect, QPoint</strong> 等，其构造函数有很多个，参数是很多种不同的常用类型，还内置了可以直接转换 QVaraint 到某些类型的函数，如 <strong>toInt(), toString(), toPoint(), toSize()</strong> 等，还是 QObject 动态 property 机制的关键，除了支持内置的类型外，QVariant 还被设计成可以存储我们自己定义的类型。</p>
<p><strong>关键术语:</strong></p>
<ul>
<li>Q_DECLARE_METATYPE</li>
<li>qRegisterMetaType</li>
<li>qRegisterMetaTypeStreamOperators</li>
<li>operator QVariant()</li>
</ul>
<span id="more"></span>

<h2 id="自定义类型和-QVariant-互相转换"><a href="#自定义类型和-QVariant-互相转换" class="headerlink" title="自定义类型和 QVariant 互相转换"></a>自定义类型和 QVariant 互相转换</h2><p>想要能够使得自定义类型的对象和 QVariant 能够互相转换，自定义类型需要在类声明的头文件中使用宏 <strong>Q_DECLARE_METATYPE()</strong> 声明一下，告知 Qt 的 Meta System:</p>
<ul>
<li>使用 <code>QVariant::fromValue(customClassObject)</code> 把自定义类型的对象转换为 QVariant 对象</li>
<li>使用 <code>variantObject.value&lt;CustomClass&gt;()</code> 把 QVariant 对象转换为自定义类型的对象</li>
</ul>
<blockquote>
<p>Adding a Q_DECLARE_METATYPE() makes the type known to all template based functions, including QVariant.</p>
</blockquote>
<p>下面使用自定义类 User 和 QVaraint 互转为例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMetaType&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">User</span>(<span class="keyword">int</span> id = <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    QString username;</span><br><span class="line">    QString password;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Q_DECLARE_METATYPE</span>(User) <span class="comment">// [1] 向 Qt Meta System 声明</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">User::<span class="built_in">User</span>(<span class="keyword">int</span> id) : <span class="built_in">id</span>(id) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argc)</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argv)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 对象转换为 QVariant</span></span><br><span class="line">    <span class="function">User <span class="title">ali</span><span class="params">(<span class="number">33</span>)</span></span>;</span><br><span class="line">    QVariant var = QVariant::<span class="built_in">fromValue</span>(ali);</span><br><span class="line">    <span class="comment">// 只有使用 Q_DECLARE_METATYPE 声明过的类 canConvert 才返回 true</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; var.canConvert&lt;User&gt;(); <span class="comment">// 输出 true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] QVarint 转换为对象</span></span><br><span class="line">    User alex = var.value&lt;User&gt;();</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; alex.id; <span class="comment">// 输出 33</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="信号槽中使用自定义类型"><a href="#信号槽中使用自定义类型" class="headerlink" title="信号槽中使用自定义类型"></a>信号槽中使用自定义类型</h2><p>如果 connect 的类型是 <strong>Qt::DirectConnection</strong>，也就是同一个线程中使用，那么不需要做什么，自定义类型的对象可以直接在信号槽中作为参数，但是如果 connect 的类型是 <strong>Qt::QueuedConnection</strong>，自定义类型除了使用宏 <strong>Q_DECLARE_METATYPE()</strong> 声明外，还必须调用 <strong>qRegisterMetaType</strong> 注册后才可以:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qRegisterMetaType&lt;User&gt;(); <span class="comment">// 注意: qRegisterMetaType 是函数，不是宏</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Adding a Q_DECLARE_METATYPE() makes the type known to all template based functions, including QVariant. Note that if you intend to use the type in queued signal and slot connections or in QObject’s property system, you also have to call qRegisterMetaType() since the names are resolved at runtime.</p>
<p>To use the type T in QVariant, using Q_DECLARE_METATYPE() is sufficient. To use the type T in queued signal and slot connections, qRegisterMetaType<T>() must be called before the first connection is established.</p>
<p>Also, to use type T with the QObject::property() API, qRegisterMetaType<T>() must be called before it is used, typically in the constructor of the class that uses T, or in the main() function.</p>
</blockquote>
<h2 id="QObject-property-中使用自定义类型"><a href="#QObject-property-中使用自定义类型" class="headerlink" title="QObject property 中使用自定义类型"></a>QObject property 中使用自定义类型</h2><p>*<em>QObject::setProperty(const char <em>name, const QVariant &amp;value)</em></em> 可以动态地存储数据，这样我们就不需要为了保存数据而定义很多变量了，使用 *<em>QObject::property(const char <em>name)</em></em> 就能够取得存储的数据，是不是非常方便！</p>
<p>为了让 QObject 的 property 支持自定义类型的对象，自定义的类需要实现运算符 **QVariant()**，如下 User 的实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMetaType&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">User</span>(<span class="keyword">int</span> id = <span class="number">50</span>);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">QVariant</span><span class="params">()</span> <span class="keyword">const</span></span>; <span class="comment">// [1] 为了支持 QObject 的 property 特性</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    QString username;</span><br><span class="line">    QString password;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Q_DECLARE_METATYPE</span>(User)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">User::<span class="built_in">User</span>(<span class="keyword">int</span> id) : <span class="built_in">id</span>(id) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User::<span class="keyword">operator</span> <span class="title">QVariant</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QVariant::<span class="built_in">fromValue</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argc)</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argv)</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">alex</span><span class="params">(<span class="number">33</span>)</span></span>;</span><br><span class="line">    QObject obj;</span><br><span class="line">    obj.<span class="built_in">setProperty</span>(<span class="string">&quot;user&quot;</span>, alex); <span class="comment">// [2] 存储自定义类型的对象</span></span><br><span class="line">    User ronnie = obj.<span class="built_in">property</span>(<span class="string">&quot;user&quot;</span>).value&lt;User&gt;(); <span class="comment">// [3] 取得自定义类型的对象</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; ronnie.id; <span class="comment">// 输出 33</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="QDataStream-序列化自定义类型的-QVariant"><a href="#QDataStream-序列化自定义类型的-QVariant" class="headerlink" title="QDataStream 序列化自定义类型的 QVariant"></a>QDataStream 序列化自定义类型的 QVariant</h2><p>自定义类型的对象转换为 QVaraint 对象后，如果要使用 QDataStream 操作这个 varaint 的话，需要:</p>
<ul>
<li>自定义类型实现 QDataStream&amp; operator&lt;&lt;(QDataStream &amp;stream, const CustomClass &amp;obj)</li>
<li>自定义类型实现 QDataStream&amp; operator&gt;&gt;(QDataStream &amp;stream, CustomClass &amp;obj)</li>
<li>使用 qRegisterMetaTypeStreamOperators 进行注册</li>
</ul>
<p>任然以 User 为例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMetaType&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDataStream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">User</span>(<span class="keyword">int</span> id = <span class="number">50</span>, <span class="keyword">const</span> QString &amp;username = <span class="built_in">QString</span>(), <span class="keyword">const</span> QString &amp;password = <span class="built_in">QString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> QDataStream&amp; <span class="keyword">operator</span>&lt;&lt;(QDataStream &amp;stream, <span class="keyword">const</span> User &amp;user);</span><br><span class="line">    <span class="keyword">friend</span> QDataStream&amp; <span class="keyword">operator</span>&gt;&gt;(QDataStream &amp;stream, User &amp;user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    QString username;</span><br><span class="line">    QString password;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Q_DECLARE_METATYPE</span>(User)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: User.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">User::<span class="built_in">User</span>(<span class="keyword">int</span> id, <span class="keyword">const</span> QString &amp;username, <span class="keyword">const</span> QString &amp;password)</span><br><span class="line">    : <span class="built_in">id</span>(id), <span class="built_in">username</span>(username), <span class="built_in">password</span>(password) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">QDataStream&amp; <span class="keyword">operator</span>&lt;&lt;(QDataStream &amp;stream, <span class="keyword">const</span> User &amp;user) &#123;</span><br><span class="line">    stream &lt;&lt; user.id &lt;&lt; user.username &lt;&lt; user.password;</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">QDataStream&amp; <span class="keyword">operator</span>&gt;&gt;(QDataStream &amp;stream, User &amp;user) &#123;</span><br><span class="line">    stream &gt;&gt; user.id &gt;&gt; user.username &gt;&gt; user.password;</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件名: main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDataStream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;User.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argc)</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(argv)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] QDataStream 操作自定义类型的 QVariant 时需要先注册</span></span><br><span class="line">    qRegisterMetaTypeStreamOperators&lt;User&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 把对象转换为 QVariant</span></span><br><span class="line">    QVariant aliVar = QVariant::<span class="built_in">fromValue</span>(<span class="built_in">User</span>(<span class="number">100</span>, <span class="string">&quot;Ali&quot;</span>, <span class="string">&quot;Secret&quot;</span>));</span><br><span class="line">    QByteArray buffer; <span class="comment">// 存储的载体</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 把 User 的 QVariant 写入 buffer</span></span><br><span class="line">    <span class="function">QDataStream <span class="title">out</span><span class="params">(&amp;buffer, QIODevice::WriteOnly)</span></span>;</span><br><span class="line">    out &lt;&lt; aliVar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 从 buffer 中读取对象</span></span><br><span class="line">    <span class="function">QDataStream <span class="title">in</span><span class="params">(&amp;buffer, QIODevice::ReadOnly)</span></span>;</span><br><span class="line">    QVariant readedAliVar;</span><br><span class="line">    in &gt;&gt; readedAliVar;</span><br><span class="line">    User readedAli = readedAliVar.value&lt;User&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出: &quot;ID: 100, Username: Ali, Password: Secret&quot;</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="built_in">QString</span>(<span class="string">&quot;ID: %1, Username: %2, Password: %3&quot;</span>)</span><br><span class="line">                .<span class="built_in">arg</span>(readedAli.id).<span class="built_in">arg</span>(readedAli.username).<span class="built_in">arg</span>(readedAli.password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/spring-web-server-validate/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          服务器端参数验证
        
      </div>
    </a>
  
  
    <a href="/fe-less/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">使用 LESS 代替 CSS</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

    </div>
</body>

</html>
