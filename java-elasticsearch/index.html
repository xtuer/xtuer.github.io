<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Elasticsearch 入门 | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ElasticSearch (下面简称 ES) 是一个基于 Lucene 的全文检索服务器，本文简单的介绍 ES 的安装、配置、启动、一些基本概念、中文分词以及使用 Java 编程访问 ES 等。 安装配置启动 安装: 目前 spring-data-elasticsearch 最高支持 elasticsearch-6.2.2 (可参考最后的版本对应进行选择)，所以下载 https:&#x2F;&#x2F;artifa">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch 入门">
<meta property="og:url" content="http://xtuer.github.io/java-elasticsearch/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="ElasticSearch (下面简称 ES) 是一个基于 Lucene 的全文检索服务器，本文简单的介绍 ES 的安装、配置、启动、一些基本概念、中文分词以及使用 Java 编程访问 ES 等。 安装配置启动 安装: 目前 spring-data-elasticsearch 最高支持 elasticsearch-6.2.2 (可参考最后的版本对应进行选择)，所以下载 https:&#x2F;&#x2F;artifa">
<meta property="og:locale">
<meta property="article:published_time" content="2019-09-14T07:03:27.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.157Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/">公孙二狗</a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		<p class="header-subtitle">大圣，此去欲何？踏南天，碎凌霄。若一去不回……？便一去不回！</p>
		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10.63px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 12.5px;">Cas</a> <a href="/tags/DB/" style="font-size: 15.63px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 14.38px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 12.5px;">Hexo</a> <a href="/tags/Index/" style="font-size: 13.13px;">Index</a> <a href="/tags/Java/" style="font-size: 19.38px;">Java</a> <a href="/tags/Mac/" style="font-size: 17.5px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.5px;">Misc</a> <a href="/tags/PHP/" style="font-size: 11.25px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.13px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.75px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 11.25px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 14.38px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.88px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.75px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 16.25px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 15.63px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 17.5px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 17.5px;">Util</a> <a href="/tags/Vue/" style="font-size: 16.88px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.88px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8"><span class="toc-text">安装配置启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3"><span class="toc-text">端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">中文分词器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">可视化客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-%E7%BC%96%E7%A8%8B%E8%AE%BF%E9%97%AE-ES"><span class="toc-text">Java 编程访问 ES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-Gradle-%E4%BE%9D%E8%B5%96"><span class="toc-text">A. Gradle 依赖:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Spring-%E9%85%8D%E7%BD%AE"><span class="toc-text">B. Spring 配置:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-%E5%AE%9A%E4%B9%89%E7%B1%BB-User-%E5%AF%B9%E5%BA%94-ES-%E7%9A%84-Document"><span class="toc-text">C. 定义类 User (对应 ES 的 Document):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#D-%E6%8F%92%E5%85%A5%E5%92%8C%E6%9F%A5%E8%AF%A2"><span class="toc-text">D. 插入和查询:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#E-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">E. 分页查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#F-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-text">F. 多条件查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-JPA-%E8%AE%BF%E9%97%AE-ES"><span class="toc-text">使用 JPA 访问 ES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-%E5%88%9B%E5%BB%BA-UserRepository-%E6%8E%A5%E5%8F%A3"><span class="toc-text">A. 创建 UserRepository 接口:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Spring-%E9%85%8D%E7%BD%AE-1"><span class="toc-text">B. Spring 配置:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-text">C. 测试代码:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-text">版本问题</span></a></li></ol>
            </div>
        </div>
    </div>


<article id="post-java-elasticsearch" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/java-elasticsearch/" class="article-date">
  	<!-- <time datetime="2019-09-14T07:03:27.000Z" itemprop="datePublished">2019-09-14</time> -->
    2019-09-14
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Elasticsearch 入门
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p>ElasticSearch (下面简称 ES) 是一个基于 Lucene 的全文检索服务器，本文简单的介绍 ES 的安装、配置、启动、一些基本概念、中文分词以及使用 Java 编程访问 ES 等。</p>
<h2 id="安装配置启动"><a href="#安装配置启动" class="headerlink" title="安装配置启动"></a>安装配置启动</h2><ol>
<li><p>安装: 目前 spring-data-elasticsearch 最高支持 elasticsearch-6.2.2 (可参考最后的版本对应进行选择)，所以下载 <a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.zip">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.zip</a>，解压即可</p>
</li>
<li><p>配置: 修改配置文件 <code>config/elasticsearch.yml</code> (只介绍单机环境的，中小型应用足够了):</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">ebag</span>      <span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span>       <span class="comment"># 节点名称</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>   <span class="comment"># 访问地址, 局域网需要访问</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span>         <span class="comment"># 端口</span></span><br></pre></td></tr></table></figure></li>
<li><p>启动: <code>elasticsearch -d</code>，注意: Linux 下不允许使用 root 用户启动，可以创建一个用户如 elasticsearch，然后使用此用户启动 ES:</p>
<ul>
<li><code>useradd elasticsearch</code></li>
<li><code>passwd elasticsearch</code></li>
<li><code>su elasticsearch</code></li>
<li><code>elasticsearch -d</code> </li>
</ul>
</li>
<li><p>浏览器中访问 <a target="_blank" rel="noopener" href="http://localhost:9200/">http://localhost:9200</a>，输出如下则说明 ES 启动成功:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;node-1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cluster_name&quot;</span>: <span class="string">&quot;ebag&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cluster_uuid&quot;</span>: <span class="string">&quot;Ogsv5NneTHyHmWDWM5hH5A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;number&quot;</span>: <span class="string">&quot;6.2.2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;build_hash&quot;</span>: <span class="string">&quot;10b1edd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;build_date&quot;</span>: <span class="string">&quot;2018-02-16T19:01:30.685723Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;build_snapshot&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;lucene_version&quot;</span>: <span class="string">&quot;7.2.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;minimum_wire_compatibility_version&quot;</span>: <span class="string">&quot;5.6.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;minimum_index_compatibility_version&quot;</span>: <span class="string">&quot;5.0.0&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;tagline&quot;</span>: <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>启动时如果发生错误，可参考 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/312dfaa3a27b">https://www.jianshu.com/p/312dfaa3a27b</a>。<span id="more"></span></p>
<h2 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h2><p>ES 中常用端口有:</p>
<ul>
<li>9200: 作为 Http 协议，主要用于外部通讯，例如使用 curl 和浏览器中访问 ES</li>
<li>9300: 作为 Tcp 协议，ES 集群之间是通过 9300 进行通讯，Java 客户端访问 ES 也是使用端口 9300</li>
</ul>
<h2 id="中文分词器"><a href="#中文分词器" class="headerlink" title="中文分词器"></a>中文分词器</h2><p>ES <a target="_blank" rel="noopener" href="https://www.itcodemonkey.com/article/7418.html">内置了很多分词器 (analyzer)</a>，例如 standard 分词器、simple 分词器、Whitespace 分词器、keyword 分词器等等，但是对中文支持都很不好，中文分词器推荐使用 <a target="_blank" rel="noopener" href="https://www.itcodemonkey.com/article/7417.html">IK</a>，安装比较简单，在 Elasticsearch 目录下执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip</span><br></pre></td></tr></table></figure>

<p>如果下载失败，可以使用下载工具先下载得到 elasticsearch-analysis-ik-6.2.2.zip，解压得到目录 <code>elasticsearch</code>，把这个目录重命名为 <code>ik</code>，复制目录 ik 到目录 <code>$&#123;elasticsearch&#125;/plugins</code>，重启 Elasticsearch 即可生效。</p>
<p>IK 有 2 种类型: ik_smart 和 ik_max_word:</p>
<ul>
<li>ik_smart: 会做最粗粒度的拆分，已被分出的词语将不会再次被其它词语占有，比如会将<code>中华人民共和国国歌</code>拆分为<code>中华人民共和国</code>、<code>国歌</code></li>
<li>ik_max_word: 会将文本做最细粒度的拆分，尽可能多的拆分出词语，比如会将<code>中华人民共和国国歌</code>拆分为<code>中华人民共和国</code>、<code>中华人民</code>、<code>中华</code>、<code>华人</code>、<code>人民共和国</code>、<code>人民</code>、<code>人</code>、<code>民</code>、<code>共和国</code>、<code>共和</code>、<code>和</code>、<code>国歌</code>等，会穷尽各种可能的组合</li>
</ul>
<p>使用 curl 查看分词效果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9200/_analyze?pretty -H &#x27;Content-Type:application/json&#x27; -d&#x27; &#123; &quot;analyzer&quot;: &quot;ik_smart&quot;, &quot;text&quot;: &quot;中华人民共和国国歌&quot; &#125; &#x27;</span><br><span class="line">curl -XPOST http://localhost:9200/_analyze?pretty -H &#x27;Content-Type:application/json&#x27; -d&#x27; &#123; &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;text&quot;: &quot;中华人民共和国国歌&quot; &#125; &#x27;</span><br></pre></td></tr></table></figure>

<p>如果使用 VS Code 的 Rest Client 的插件，还可以用下面的代码查看分词的效果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">### 分词 ik-smart</span><br><span class="line">http://localhost:9200/_analyze?pretty</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;simple&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;中华人民共和国公民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">### 分词 ik_max_word</span><br><span class="line">http://localhost:9200/_analyze?pretty</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;中华人民共和国公民&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 analyzer 为不同的分词器，看看不同的分词效果。</p>
<h2 id="可视化客户端"><a href="#可视化客户端" class="headerlink" title="可视化客户端"></a>可视化客户端</h2><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016844135">ES 可视化管理工具</a>, 可使用 <a target="_blank" rel="noopener" href="https://github.com/360EntSecGroup-Skylar/ElasticHD">ElasticHD</a>:</p>
<ol>
<li>下载 (Mac 选择 elasticHD_darwin_i386.zip)</li>
<li>解压</li>
<li>启动: <code>./ElasticHD -p 127.0.0.1:9800</code></li>
<li>访问: <code>http://localhost:9800</code></li>
</ol>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>ES 的数据类型有:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FieldType</span> </span>&#123;</span><br><span class="line">    Text,</span><br><span class="line">    Integer,</span><br><span class="line">    Long,</span><br><span class="line">    Date,</span><br><span class="line">    Float,</span><br><span class="line">    Double,</span><br><span class="line">    Boolean,</span><br><span class="line">    Object,</span><br><span class="line">    Auto,</span><br><span class="line">    Nested,</span><br><span class="line">    Ip,</span><br><span class="line">    Attachment,</span><br><span class="line">    Keyword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 Text 和 Keyword 都是存储字符串的，但是建立索引和搜索的时候是不太一样:</p>
<ul>
<li><p>Text:</p>
<ul>
<li>支持分词、全文检索、支持模糊、精确查询，不支持聚合、排序操作</li>
<li>最大支持的字符长度无限制，适合大字段存储</li>
</ul>
</li>
<li><p>Keyword:</p>
<ul>
<li>不进行分词、直接索引、精确匹配、不支持模糊，支持聚合、排序操作</li>
<li>最大支持的长度为 32766 个 UTF-8 类型的字符</li>
</ul>
</li>
</ul>
<h2 id="Java-编程访问-ES"><a href="#Java-编程访问-ES" class="headerlink" title="Java 编程访问 ES"></a>Java 编程访问 ES</h2><p>下面举例使用 spring-data-elasticsearch 的 <code>ElasticsearchTemplate</code> 访问 ES。</p>
<h3 id="A-Gradle-依赖"><a href="#A-Gradle-依赖" class="headerlink" title="A. Gradle 依赖:"></a>A. Gradle 依赖:</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">compile(</span><br><span class="line">        <span class="string">&quot;org.springframework:spring-context-support:5.0.2.RELEASE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;org.springframework.data:spring-data-elasticsearch:3.1.10.RELEASE&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注: 下面的依赖是为了开发方便而使用的，不是必须的依赖</span></span><br><span class="line">testCompile <span class="string">&quot;junit:junit:4.12&quot;</span></span><br><span class="line">testCompile <span class="string">&quot;org.springframework:spring-test:5.0.2.RELEASE&quot;</span></span><br><span class="line">compileOnly <span class="string">&quot;org.projectlombok:lombok:1.16.20&quot;</span></span><br><span class="line">annotationProcessor <span class="string">&quot;org.projectlombok:lombok:1.16.20&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="B-Spring-配置"><a href="#B-Spring-配置" class="headerlink" title="B. Spring 配置:"></a>B. Spring 配置:</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:elasticsearch</span>=<span class="string">&quot;http://www.springframework.org/schema/data/elasticsearch&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/data/elasticsearch</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/data/elasticsearch/spring-elasticsearch.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch:transport-client</span> <span class="attr">id</span>=<span class="string">&quot;client&quot;</span> <span class="attr">cluster-nodes</span>=<span class="string">&quot;127.0.0.1:9300&quot;</span> <span class="attr">cluster-name</span>=<span class="string">&quot;ebag&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;elasticsearchTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.data.elasticsearch.core.ElasticsearchTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;client&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;client&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="C-定义类-User-对应-ES-的-Document"><a href="#C-定义类-User-对应-ES-的-Document" class="headerlink" title="C. 定义类 User (对应 ES 的 Document):"></a>C. 定义类 User (对应 ES 的 Document):</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.FieldType;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username; <span class="comment">// 英文</span></span><br><span class="line">    <span class="keyword">private</span> String nickname; <span class="comment">// 中文</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(<span class="keyword">long</span> id, String username, String nickname)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.nickname = nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示:</p>
<ul>
<li><code>@Document(indexName = &quot;user&quot;)</code> 表示 User 的对象作为一个 Document 存储到 ES 的 Index <code>user</code> 中</li>
<li><code>@Id private long id</code> 表示使用 User’s id 作为 ES Document 的 ID</li>
<li><code>User</code> 的所有属性都会保存到 ES</li>
</ul>
</blockquote>
<h3 id="D-插入和查询"><a href="#D-插入和查询" class="headerlink" title="D. 插入和查询:"></a>D. 插入和查询:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xtuer.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.IndexQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.SearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:elasticsearch.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化数据</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除 index user</span></span><br><span class="line">        elasticsearchTemplate.deleteIndex(User.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入 users 到 index user (index 不存在会自动创建)</span></span><br><span class="line">        elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;Marjory Joyce&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>)).build());</span><br><span class="line">        elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">&quot;Lamb Cook&quot;</span>, <span class="string">&quot;中华人民&quot;</span>)).build());</span><br><span class="line">        elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">&quot;Katharine Warren&quot;</span>, <span class="string">&quot;和&quot;</span>)).build());</span><br><span class="line">        elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">4</span>, <span class="string">&quot;Dillon George&quot;</span>, <span class="string">&quot;共和国公民&quot;</span>)).build());</span><br><span class="line">        elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">5</span>, <span class="string">&quot;Dillon George&quot;</span>, <span class="string">&quot;你和我&quot;</span>)).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 username 查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUsersByUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SearchQuery query = <span class="keyword">new</span> NativeSearchQueryBuilder().withQuery(QueryBuilders.matchQuery(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;Cook&quot;</span>)).build();</span><br><span class="line">        List&lt;User&gt; users = elasticsearchTemplate.queryForList(query, User.class); <span class="comment">// User.class 指定了 indexName, 返回类型</span></span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 nickname 查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUsersByNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SearchQuery query = <span class="keyword">new</span> NativeSearchQueryBuilder().withQuery(QueryBuilders.matchQuery(<span class="string">&quot;nickname&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>)).build();</span><br><span class="line">        List&lt;User&gt; users = elasticsearchTemplate.queryForList(query, User.class);</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>findUsersByNickname()</code> 发现把 <code>initIndex()</code>中插入的所有数据都搜索出来了，上面安装的中文分词器 IK 并没有生效，这是因为 ES 中存储 User 的 Document 中的属性没有指定分词器，则自动使用默认的 standard 分词器 (每个中文字符作为一个 token)，所以 nickname 只要包含<code>中华人民共和国公民</code>中的任何一个中文字符的 Document 都会被搜索出来。</p>
<p>为了使用 IK 分词器，需要修改 2 个地方:</p>
<ol>
<li><p>使用注解 <code>@Field</code> 给属性 nickname 设定类型为 <strong>Text</strong> 和分词器 <strong>ik_smart</strong> (根据业务需求，也可以用 <strong>ik_max_word</strong>):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text, searchAnalyzer = &quot;ik_smart&quot;, analyzer = &quot;ik_smart&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String nickname;</span><br></pre></td></tr></table></figure></li>
<li><p>在插入数据前给 ElasticsearchTemplate 添加映射器 <code>User.class</code>，ElasticsearchTemplate 会根据 User.class 中的注解 <code>@Field</code> 创建 Document 的 schema，确定属性的类型和分词器，插入数据时就会使用正确的分词器建立索引了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 删除 index user</span></span><br><span class="line">    elasticsearchTemplate.deleteIndex(User.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 Index 不存在则创建</span></span><br><span class="line">    <span class="keyword">if</span> (!elasticsearchTemplate.indexExists(User.class)) &#123;</span><br><span class="line">        elasticsearchTemplate.createIndex(User.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不设置，则会使用默认分词器</span></span><br><span class="line">    elasticsearchTemplate.putMapping(User.class); <span class="comment">// 需要索引已经存在, 会使用 User 中的 @Field 确定分词器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入 users 到 index user</span></span><br><span class="line">    elasticsearchTemplate.index(<span class="keyword">new</span> IndexQueryBuilder().withObject(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;Marjory Joyce&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>)).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>调用 <code>findUsersByNickname()</code> 进行查询，IK 分词器生效了 (搜索时不需要给 ElasticsearchTemplate 添加映射器 <code>User.class</code>)</p>
</li>
</ol>
<p>推荐把 ES 的操作放到 Service 里，Service 实现 InitializingBean 接口，在 <code>afterPropertiesSet()</code> 中设置映射器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchService</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    ... <span class="comment">// 操作 ES</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!elasticsearchTemplate.indexExists(User.class)) &#123;</span><br><span class="line">           elasticsearchTemplate.createIndex(User.class);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       elasticsearchTemplate.putMapping(User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="E-分页查询"><a href="#E-分页查询" class="headerlink" title="E. 分页查询"></a>E. 分页查询</h3><p>使用 PageRequest 创建分页对象，页码从 0 开始:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUsersByNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SearchQuery query = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">            .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;nickname&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>))</span><br><span class="line">            .withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            .build();</span><br><span class="line">    List&lt;User&gt; users = elasticsearchTemplate.queryForList(query, User.class);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="F-多条件查询"><a href="#F-多条件查询" class="headerlink" title="F. 多条件查询"></a>F. 多条件查询</h2><p>使用 BoolQueryBuilder 创建多条件 Query:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;Joyce&quot;</span>));</span><br><span class="line">    boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;nickname&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>));</span><br><span class="line"></span><br><span class="line">    SearchQuery query = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">            .withQuery(boolQueryBuilder)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; users = elasticsearchTemplate.queryForList(query, User.class);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-JPA-访问-ES"><a href="#使用-JPA-访问-ES" class="headerlink" title="使用 JPA 访问 ES"></a>使用 JPA 访问 ES</h2><h3 id="A-创建-UserRepository-接口"><a href="#A-创建-UserRepository-接口" class="headerlink" title="A. 创建 UserRepository 接口:"></a>A. 创建 UserRepository 接口:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.repo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xtuer.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByNickname</span><span class="params">(String nickname)</span></span>;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByNickname</span><span class="params">(String nickname, PageRequest pageRequest)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>方法名 findByNickname 和 findUsersByNickname 都是对的。<br>更多方法命名请参考 JPA 规范。</p>
</blockquote>
<h3 id="B-Spring-配置-1"><a href="#B-Spring-配置-1" class="headerlink" title="B. Spring 配置:"></a>B. Spring 配置:</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:elasticsearch</span>=<span class="string">&quot;http://www.springframework.org/schema/data/elasticsearch&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/data/elasticsearch</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/data/elasticsearch/spring-elasticsearch.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:elasticsearch.xml&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置 Repository 的包路径，自动生成 Repository 对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch:repositories</span> <span class="attr">base-package</span>=<span class="string">&quot;com.xtuer.repo&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果不喜欢上面的 XML 配置 Elasticsearch Repository，也可以使用下面的 Java 代码来创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.config.EnableElasticsearchRepositories;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories(basePackages = &quot;com.xtuer.repo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>记得配置 <code>&lt;context:component-scan base-package=&quot;com.xtuer.config&quot;/&gt;</code>。</p>
</blockquote>
<h3 id="C-测试代码"><a href="#C-测试代码" class="headerlink" title="C. 测试代码:"></a>C. 测试代码:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xtuer.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.xtuer.repo.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.SearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:bean.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWithRepository</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userRepository.deleteAll();</span><br><span class="line"></span><br><span class="line">        userRepository.save(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;Marjory Joyce&quot;</span>, <span class="string">&quot;中华人民共和国公民&quot;</span>));</span><br><span class="line">        userRepository.save(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">&quot;Lamb Cook&quot;</span>, <span class="string">&quot;中华人民&quot;</span>));</span><br><span class="line">        userRepository.save(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">&quot;Katharine Warren&quot;</span>, <span class="string">&quot;和&quot;</span>));</span><br><span class="line">        userRepository.save(<span class="keyword">new</span> User(<span class="number">4</span>, <span class="string">&quot;Dillon George&quot;</span>, <span class="string">&quot;共和国公民&quot;</span>));</span><br><span class="line">        userRepository.save(<span class="keyword">new</span> User(<span class="number">5</span>, <span class="string">&quot;Dillon George&quot;</span>, <span class="string">&quot;你和我&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意: 使用 JPA 规范命名的接口查询得到的数据不全 (不知道为啥)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不使用分页</span></span><br><span class="line">        System.out.println(userRepository.findByNickname(<span class="string">&quot;共和国公民&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用分页</span></span><br><span class="line">        List&lt;User&gt; users = userRepository.findByNickname(<span class="string">&quot;共和国公民&quot;</span>, PageRequest.of(<span class="number">0</span>, <span class="number">11</span>));</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意: 自定义 Query 的方式查询得到的数据是全的，和使用 ElasticsearchTemplate 查询得到的结果一样</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchByNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SearchQuery query = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">                .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;nickname&quot;</span>, <span class="string">&quot;共和国公民&quot;</span>))</span><br><span class="line">                .withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">11</span>))</span><br><span class="line">                .build();</span><br><span class="line">        Page&lt;User&gt; users = userRepository.search(query);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li>创建数据时不需要 ElasticsearchTemplate 先调用 <code>putMapping(User.class)</code>，Repository 会自动调用</li>
<li>使用 JPA 规范命名的接口 <code>UserRepository.findByNickname()</code> 查询得到的数据不全，但是使用自定义 Query 的方式查询到的数据是全的 (<code>userRepository.search(query)</code>)</li>
<li>既能按照 JPA 的命名规范进行简单操作，还能使用自定义 Query 实现复杂查询</li>
</ul>
<h2 id="版本问题"><a href="#版本问题" class="headerlink" title="版本问题"></a>版本问题</h2><p>Spring Data Elasticsearch 和 Elasticsearch 的版本如果选择不正确，运行时就会报错，可以参考下面版本之间的关系，开发时选择对应的版本:</p>
<table>
<thead>
<tr>
<th align="left">Spring Data Elasticsearch</th>
<th align="left">Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td align="left">3.1.x</td>
<td align="left">6.2.2</td>
</tr>
<tr>
<td align="left">3.0.x</td>
<td align="left">5.5.0</td>
</tr>
<tr>
<td align="left">2.1.x</td>
<td align="left">2.4.0</td>
</tr>
<tr>
<td align="left">2.0.x</td>
<td align="left">2.2.0</td>
</tr>
<tr>
<td align="left">1.3.x</td>
<td align="left">1.5.2</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-data-elasticsearch/wiki/Spring-Boot-and-Spring-Data-Elasticsearch">Spring Boot and Elasticsearch 之间的版本关系</a>:</p>
<table>
<thead>
<tr>
<th>Spring Boot</th>
<th>Spring Boot Elasticsearch Starter</th>
<th>Spring Data Elasticsearch</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td>2.1.6.RELEASE</td>
<td>6.4.3</td>
<td>3.1.9.RELEASE</td>
<td>6.2.2</td>
</tr>
<tr>
<td>2.1.5.RELEASE</td>
<td>6.4.3</td>
<td>3.1.8.RELEASE</td>
<td>6.2.2</td>
</tr>
<tr>
<td>2.1.4.RELEASE</td>
<td>6.4.3</td>
<td>3.1.6.RELEASE</td>
<td>6.2.2</td>
</tr>
</tbody></table>

        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/vue-dnd/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Vue 中实现拖拽
        
      </div>
    </a>
  
  
    <a href="/fe-async-validator/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Async Validator</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

    </div>
</body>

</html>
