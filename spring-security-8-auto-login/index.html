<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Spring Security 自动登录 | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Spring Security 怎么判断一个用户是否登录了呢？ 非常的简单，只要 Spring Context 中存储了一个 Authentication 的对象，那么 Spring Security 就认为用户已经登录。所以所有的操作都是为了往 Spring Context 中存储了一个 Authentication 的对象，这样就实现了自动登录的功能: 123User user &#x3D; new U">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security 自动登录">
<meta property="og:url" content="http://xtuer.github.io/spring-security-8-auto-login/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="Spring Security 怎么判断一个用户是否登录了呢？ 非常的简单，只要 Spring Context 中存储了一个 Authentication 的对象，那么 Spring Security 就认为用户已经登录。所以所有的操作都是为了往 Spring Context 中存储了一个 Authentication 的对象，这样就实现了自动登录的功能: 123User user &#x3D; new U">
<meta property="og:locale">
<meta property="article:published_time" content="2017-02-27T06:43:09.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.183Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="SpringSecurity">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">

  <!-- mermaid.js (8.7.0) 需要在 require.js 前面加载 -->
  <script src='/js/mermaid.min.js'></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/">公孙二狗</a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		<p class="header-subtitle">大圣，此去欲何？踏南天，碎凌霄。若一去不回……？便一去不回！</p>
		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 11.67px;">Cas</a> <a href="/tags/DB/" style="font-size: 15px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 13.89px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 12.22px;">Hexo</a> <a href="/tags/Index/" style="font-size: 12.78px;">Index</a> <a href="/tags/Java/" style="font-size: 19.44px;">Java</a> <a href="/tags/Mac/" style="font-size: 17.78px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.22px;">Misc</a> <a href="/tags/PHP/" style="font-size: 10.56px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.33px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.89px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 11.11px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 13.89px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.11px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.33px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 15.56px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 14.44px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 15px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 16.67px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 16.67px;">Util</a> <a href="/tags/Vue/" style="font-size: 16.11px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.11px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MyUserDetails-java"><span class="toc-text">MyUserDetails.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyUserDetailsService-java"><span class="toc-text">MyUserDetailsService.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyAuthenticationProvider-java"><span class="toc-text">MyAuthenticationProvider.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SecurityUtils-java"><span class="toc-text">SecurityUtils.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UserDao-java"><span class="toc-text">UserDao.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AutoLoginController-java"><span class="toc-text">AutoLoginController.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-security-xml"><span class="toc-text">spring-security.xml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#login-fm"><span class="toc-text">login.fm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%8B%E8%BD%BD"><span class="toc-text">项目下载</span></a></li></ol>
            </div>
        </div>
    </div>


<article id="post-spring-security-8-auto-login" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/spring-security-8-auto-login/" class="article-date">
  	<!-- <time datetime="2017-02-27T06:43:09.000Z" itemprop="datePublished">2017-02-27</time> -->
    2017-02-27
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring Security 自动登录
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringSecurity/" rel="tag">SpringSecurity</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p><strong>Spring Security 怎么判断一个用户是否登录了呢？</strong></p>
<p>非常的简单，只要 Spring Context 中存储了一个 Authentication 的对象，那么 Spring Security 就认为用户已经登录。所以所有的操作都是为了往 Spring Context 中存储了一个 Authentication 的对象，这样就实现了自动登录的功能:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User(...);</span><br><span class="line">Authentication auth = UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities());</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(auth);</span><br></pre></td></tr></table></figure>

<p>下面的代码都是为了结合某些业务一起介绍的，写的很冗杂，不管怎么做，核心功能只要围绕上面这几行代码即可。</p>
<hr>
<p>前面的实现可以使用表单进行登陆了，但是某些时候需要自动登录，例如使用 QQ 的第三方登录，服务器收到登陆成功的回调后，需要在我们的系统中继续使用本地账号登陆才行，这时就会需要实现自动登录的功能，还有使用 AJAX 等也不能使用表单登陆，也是需要调用登陆的接口才可以。</p>
<p>为了提供登陆的接口，需要实现 <strong>AuthenticationProvider</strong> 进行登陆，不再使用 Spring Security 的默认实现。当然实现了自动登录后，并不会影响 Spring Security 的表单登陆。</p>
<span id="more"></span>

<p>项目的文件如下，需要增加修改的文件有:</p>
<ul>
<li>MyUserDetails.java </li>
<li>MyUserDetailsService.java</li>
<li>MyAuthenticationProvider.java</li>
<li>SecurityUtils.java</li>
<li>UserDao.java</li>
<li>AutoLoginController.java</li>
<li>spring-security.xml</li>
<li>login.fm</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">├── java</span><br><span class="line">│   └── com</span><br><span class="line">│       └── xtuer</span><br><span class="line">│           ├── bean</span><br><span class="line">│           │   ├── User.java</span><br><span class="line">│           │   └── UserRole.java</span><br><span class="line">│           ├── controller</span><br><span class="line">│           │   ├── AutoLoginController.java</span><br><span class="line">│           │   ├── HelloController.java</span><br><span class="line">│           │   └── LoginController.java</span><br><span class="line">│           ├── dao</span><br><span class="line">│           │   └── UserDao.java</span><br><span class="line">│           ├── security</span><br><span class="line">│           │   ├── MyAuthenticationProvider.java</span><br><span class="line">│           │   ├── MyUserDetails.java</span><br><span class="line">│           │   ├── MyUserDetailsService.java</span><br><span class="line">│           │   └── SecurityUtils.java</span><br><span class="line">│           └── service</span><br><span class="line">├── resources</span><br><span class="line">│   └── config</span><br><span class="line">│       ├── spring-mvc.xml</span><br><span class="line">│       └── spring-security.xml</span><br><span class="line">└── webapp</span><br><span class="line">    └── WEB-INF</span><br><span class="line">        ├── static</span><br><span class="line">        ├── view</span><br><span class="line">        │   ├── admin.fm</span><br><span class="line">        │   ├── hello.fm</span><br><span class="line">        │   └── login.fm</span><br><span class="line">        └── web.xml</span><br></pre></td></tr></table></figure>

<h2 id="MyUserDetails-java"><a href="#MyUserDetails-java" class="headerlink" title="MyUserDetails.java"></a>MyUserDetails.java</h2><p>自定义的 UserDetails 作为 Principle 保存到 Spring Security 的登陆信息里，这样就可以使用自定义的 UserDetails 根据我们的业务规则保存足够的信息，默认的 Principle 只保存了用户名，绝大多数时候只有用户名是不够的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xtuer.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.xtuer.bean.UserRole;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义的 UserDetails 可以保存用户的其他信息到 session 里, 例如 user id 等.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetails</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">security</span>.<span class="title">core</span>.<span class="title">userdetails</span>.<span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyUserDetails</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(user.getUsername(), user.getPassword(), user.isEnabled(), <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, buildUserAuthorities(user));</span><br><span class="line">        <span class="keyword">this</span>.userId = user.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把用户的权限 UserRole 转换成 GrantedAuthority</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;GrantedAuthority&gt; <span class="title">buildUserAuthorities</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        Set&lt;UserRole&gt; userRoles = user.getUserRoles();</span><br><span class="line">        Set&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> HashSet&lt;GrantedAuthority&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Build user&#x27;s authorities</span></span><br><span class="line">        <span class="keyword">for</span> (UserRole userRole : userRoles) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(userRole.getRole()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;GrantedAuthority&gt;(authorities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MyUserDetailsService-java"><a href="#MyUserDetailsService-java" class="headerlink" title="MyUserDetailsService.java"></a>MyUserDetailsService.java</h2><p>使用用户名从数据库查找到用户的信息，然后构建 UserDetails。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xtuer.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao = <span class="keyword">new</span> UserDao();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 username 加载用户的信息，如密码，权限等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 登陆表单中用户输入的用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        com.xtuer.bean.User user = userDao.findUserByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(username + <span class="string">&quot; not found!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> MyUserDetails(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/technical-overview.html#d4e731">The UserDetailsService</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line"><span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;</span><br><span class="line">    String username = ((UserDetails)principal).getUsername();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    String username = principal.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Another item to note from the above code fragment is that you can obtain a principal from the Authentication object. The principal is just an Object. Most of the time this can be cast into a UserDetails object. UserDetails is a central interface in Spring Security. It represents a principal, but in an extensible and application-specific way. Think of UserDetails as the adapter between your own user database and what Spring Security needs inside the SecurityContextHolder. Being a representation of something from your own user database, quite often you will cast the UserDetails to the original object that your application provided, so you can call business-specific methods (like getEmail(), getEmployeeNumber() and so on).</p>
<p>By now you’re probably wondering, so when do I provide a UserDetails object? How do I do that? I thought you said this thing was declarative and I didn’t need to write any Java code - what gives? The short answer is that there is a special interface called UserDetailsService. The only method on this interface accepts a String-based username argument and returns a UserDetails:</p>
<p>UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;<br>This is the most common approach to loading information for a user within Spring Security and you will see it used throughout the framework whenever information on a user is required.</p>
<p>On successful authentication, UserDetails is used to build the Authentication object that is stored in the SecurityContextHolder (more on this below). The good news is that we provide a number of UserDetailsService implementations, including one that uses an in-memory map (InMemoryDaoImpl) and another that uses JDBC (JdbcDaoImpl). Most users tend to write their own, though, with their implementations often simply sitting on top of an existing Data Access Object (DAO) that represents their employees, customers, or other users of the application. Remember the advantage that whatever your UserDetailsService returns can always be obtained from the SecurityContextHolder using the above code fragment.</p>
</blockquote>
<h2 id="MyAuthenticationProvider-java"><a href="#MyAuthenticationProvider-java" class="headerlink" title="MyAuthenticationProvider.java"></a>MyAuthenticationProvider.java</h2><p>MyAuthenticationProvider 提供了登陆的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource(name=&quot;userDetailsService&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name=&quot;passwordEncoder&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">// [1] token 中的用户名和密码都是用户输入的，不是数据库里的</span></span><br><span class="line">        UsernamePasswordAuthenticationToken token = (UsernamePasswordAuthenticationToken) authentication;</span><br><span class="line">        <span class="comment">// [2] 使用用户名从数据库读取用户信息</span></span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername(token.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [3] 检查用户信息</span></span><br><span class="line">        <span class="keyword">if</span>(userDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userDetails.isEnabled())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DisabledException(<span class="string">&quot;用户已被禁用&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userDetails.isAccountNonExpired()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AccountExpiredException(<span class="string">&quot;账号已过期&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userDetails.isAccountNonLocked()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">&quot;账号已被锁定&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userDetails.isCredentialsNonExpired()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">&quot;凭证已过期&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [4] 根据不同的情况比对密码</span></span><br><span class="line">        <span class="keyword">if</span> (isOAuthUser(userDetails)) &#123;</span><br><span class="line">            <span class="comment">// 通过 OAuth 登陆过来的，例如密码是调用 SecurityHelper.login() 前判断是 OAuth 合法登陆的，</span></span><br><span class="line">            <span class="comment">// 然后就查询数据库得到本地用户的密码，这里可以只需要和数据库里的使用等于比较就可以了，具体的仍然需要根据业务逻辑调整</span></span><br><span class="line">            <span class="comment">// 如果不涉及到 OAuth 用户登陆，可以删除此段代码</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String encryptedPassword = userDetails.getPassword();   <span class="comment">// 数据库用户的密码，一般都是加密过的</span></span><br><span class="line">            String inputPassword = (String) token.getCredentials(); <span class="comment">// 用户输入的密码</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据加密算法加密用户输入的密码，然后和数据库中保存的密码进行比较</span></span><br><span class="line">            <span class="keyword">if</span>(!passwordEncoder.matches(inputPassword, encryptedPassword)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;用户名/密码无效&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [5] 成功登陆，把用户信息提交给 Spring Security</span></span><br><span class="line">        <span class="comment">// 把 userDetails 作为 principal 的好处是可以放自定义的 UserDetails，这样可以存储更多有用的信息，而不只是 username，</span></span><br><span class="line">        <span class="comment">// 默认只有 username，这里的密码使用数据库中保存的密码，而不是用户输入的明文密码，否则就暴露了密码的明文</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, userDetails.getPassword(), userDetails.getAuthorities());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UsernamePasswordAuthenticationToken.class.equals(authentication);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否通过 OAuth 登陆的用户，例如 QQ，优酷等都提供了 OAuth 第三方登陆服务。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetails</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果是 OAuth 用户则返回 true，否则返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOAuthUser</span><span class="params">(UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 以 QQ_ 开头的用户名，说明是使用 QQ 的 OAuth 登陆的用户</span></span><br><span class="line">        <span class="comment">// 以 YK_ 开头的用户名，说明是使用优酷的 OAuth 登陆的用户</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> userDetails.getUsername().startsWith(<span class="string">&quot;QQ_&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SecurityUtils-java"><a href="#SecurityUtils-java" class="headerlink" title="SecurityUtils.java"></a>SecurityUtils.java</h2><p>SecurityUtils 提供了登陆的接口 <code>login()</code>，还有一些和登陆有关的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.savedrequest.HttpSessionRequestCache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.savedrequest.SavedRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityUtils</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;authenticationManager&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenBasedRememberMeServices tokenBasedRememberMeServices;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前用户是否已经登陆</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 登陆状态返回 true, 否则返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String username = SecurityContextHolder.getContext().getAuthentication().getName();</span><br><span class="line">        <span class="keyword">return</span> !<span class="string">&quot;anonymousUser&quot;</span>.equals(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取得登陆用户的 ID, 如果没有登陆则返回 -1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 登陆用户的 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getLoginUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object principle = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SecurityUtils.isLogin()) &#123;</span><br><span class="line">            MyUserDetails userDetails = (MyUserDetails) principle;</span><br><span class="line">            <span class="keyword">return</span> userDetails.getUserId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登陆</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 登陆后需要访问的页面的 URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        HttpServletResponse response = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();</span><br><span class="line"></span><br><span class="line">        String defaultTargetUrl = <span class="string">&quot;/&quot;</span>; <span class="comment">// 默认登陆成功的页面</span></span><br><span class="line">        String redirectUrl = <span class="string">&quot;/login?error=1&quot;</span>; <span class="comment">// 默认为登陆错误页面</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Authentication token = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line">            token = authenticationManager.authenticate(token); <span class="comment">// 登陆</span></span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(token);</span><br><span class="line">            tokenBasedRememberMeServices.onLoginSuccess(request, response, token); <span class="comment">// 使用 remember me</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重定向到登陆前的页面</span></span><br><span class="line">            SavedRequest savedRequest = <span class="keyword">new</span> HttpSessionRequestCache().getRequest(request, response);</span><br><span class="line">            redirectUrl = (savedRequest != <span class="keyword">null</span>) ? savedRequest.getRedirectUrl() : defaultTargetUrl;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.out.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirectUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UserDao-java"><a href="#UserDao-java" class="headerlink" title="UserDao.java"></a>UserDao.java</h2><p>增加了 QQ 用户 QQ_Admin，用户名的前缀为 QQ_，只是为了模拟第三方登录后需要使用本地账号自动登录时使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xtuer.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.xtuer.bean.UserRole;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, User&gt; users = <span class="keyword">new</span> HashMap&lt;String, User&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟数据源，可以是多种，如数据库，LDAP，从配置文件读取等</span></span><br><span class="line">        UserRole userRole = <span class="keyword">new</span> UserRole(<span class="string">&quot;ROLE_USER&quot;</span>);   <span class="comment">// 普通用户权限</span></span><br><span class="line">        UserRole adminRole = <span class="keyword">new</span> UserRole(<span class="string">&quot;ROLE_ADMIN&quot;</span>); <span class="comment">// 管理员权限</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Passw0rd 的 BCrypt 加密结果</span></span><br><span class="line">        String password = <span class="string">&quot;$2a$10$gtaxGaHMfxMRj6rqK/kp0.5TPF13CBvnXhvD7teUmeftH1cX0Mb6S&quot;</span>;</span><br><span class="line">        users.put(<span class="string">&quot;admin&quot;</span>, <span class="keyword">new</span> User(<span class="string">&quot;admin&quot;</span>, password, <span class="keyword">true</span>, <span class="keyword">new</span> HashSet&lt;UserRole&gt;(Arrays.asList(adminRole))));</span><br><span class="line">        users.put(<span class="string">&quot;alice&quot;</span>, <span class="keyword">new</span> User(<span class="string">&quot;alice&quot;</span>, password, <span class="keyword">true</span>, <span class="keyword">new</span> HashSet&lt;UserRole&gt;(Arrays.asList(userRole))));</span><br><span class="line">        users.put(<span class="string">&quot;QQ_admin&quot;</span>, <span class="keyword">new</span> User(<span class="string">&quot;QQ_admin&quot;</span>, password, <span class="keyword">true</span>, <span class="keyword">new</span> HashSet&lt;UserRole&gt;(Arrays.asList(adminRole))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> users.get(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AutoLoginController-java"><a href="#AutoLoginController-java" class="headerlink" title="AutoLoginController.java"></a>AutoLoginController.java</h2><p>在 AutoLoginController 中实现列举了第三方登录后绑定本地用户，然后自动登录的逻辑，使用登陆接口进行登陆，AJAX 实现登陆时就可以用到，还有不存在的用户登陆。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xtuer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xtuer.security.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoLoginController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource(name=&quot;securityUtils&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> SecurityUtils securityUtils;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * OAuth 用户绑定本地用户</span></span><br><span class="line"><span class="comment">     * 然后自动登陆</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/bindingUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">bindingUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// [[1]] 绑定已有用户</span></span><br><span class="line">        <span class="comment">// [[2]] 绑定好后进行自动登陆</span></span><br><span class="line">        String username = <span class="string">&quot;QQ_admin&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;wrong&quot;</span>; <span class="comment">// OAuth 授权的用户登陆不需要密码，因为不是在我们平台登陆的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + securityUtils.login(username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不存在的用户登陆</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nonExistingUserLogin&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">nonExistingUserLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String username = <span class="string">&quot;nonExistingUser&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;flash&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + securityUtils.login(username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * admin 登陆</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/adminLogin&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">adminLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;Passw0rd&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + securityUtils.login(username, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="spring-security-xml"><a href="#spring-security-xml" class="headerlink" title="spring-security.xml"></a>spring-security.xml</h2><p>需要注意的是和以前相比较，authentication-manager 的配置有变化，把密码加密部分去掉了，密码匹配的实现在 MyAuthenticationProvider 中使用。还因为使用了 @Resource, @Autowired 自动装配功能，所以需要把 <code>&lt;context:annotation-config/&gt;</code> 添加到配置中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans:beans</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/security&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:beans</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/security</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/security/spring-security.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">auto-config</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">access</span>=<span class="string">&quot;permitAll&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/admin&quot;</span> <span class="attr">access</span>=<span class="string">&quot;hasRole(&#x27;ADMIN&#x27;)&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">form-login</span> <span class="attr">login-page</span>=<span class="string">&quot;/login&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">login-processing-url</span>=<span class="string">&quot;/login&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">default-target-url</span>  =<span class="string">&quot;/hello&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">authentication-failure-url</span>=<span class="string">&quot;/login?error=1&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">username-parameter</span>=<span class="string">&quot;username&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">password-parameter</span>=<span class="string">&quot;password&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">access-denied-handler</span> <span class="attr">error-page</span>=<span class="string">&quot;/deny&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logout</span> <span class="attr">logout-url</span>=<span class="string">&quot;/logout&quot;</span> <span class="attr">logout-success-url</span>=<span class="string">&quot;/login?logout=1&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">csrf</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">remember-me</span> <span class="attr">key</span>=<span class="string">&quot;uniqueAndSecret&quot;</span> <span class="attr">token-validity-seconds</span>=<span class="string">&quot;2592000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">http</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans:bean</span> <span class="attr">id</span>=<span class="string">&quot;securityUtils&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xtuer.security.SecurityUtils&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans:bean</span> <span class="attr">id</span>=<span class="string">&quot;passwordEncoder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans:bean</span> <span class="attr">id</span>=<span class="string">&quot;userDetailsService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xtuer.security.MyUserDetailsService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans:bean</span> <span class="attr">id</span>=<span class="string">&quot;authenticationProvider&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xtuer.security.MyAuthenticationProvider&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">authentication-manager</span> <span class="attr">alias</span>=<span class="string">&quot;authenticationManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">authentication-provider</span> <span class="attr">ref</span>=<span class="string">&quot;authenticationProvider&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">authentication-manager</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans:beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="login-fm"><a href="#login-fm" class="headerlink" title="login.fm"></a>login.fm</h2><p>增加了几种不同的登陆链接。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Login Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    $&#123;error!&#125;$&#123;logout!&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;loginForm&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">        Username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span>/&gt;</span> Remember Me<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登陆&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/bindingUser&quot;</span>&gt;</span>QQ 绑定用户自动登陆<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/adminLogin&quot;</span>&gt;</span>Admin 登陆<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/nonExistingUserLogin&quot;</span>&gt;</span>不存在用户登陆<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ol>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost:8080/admin">http://localhost:8080/admin</a>，重定向到登陆页面</li>
<li>使用表单登陆，功能和以前一样</li>
<li>注销，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/admin">http://localhost:8080/admin</a>，重定向到登陆页面</li>
<li>点击 <code>QQ 绑定用户自动登陆</code>，登陆成功后重定向到 Admin 页面</li>
<li>注销，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/admin">http://localhost:8080/admin</a>，重定向到登陆页面</li>
<li>点击，<code>Admin 登陆</code>，登陆成功后重定向到 Admin 页面</li>
<li>注销，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/admin">http://localhost:8080/admin</a>，重定向到登陆页面</li>
<li>点击 <code>不存在用户登陆</code>，提示登陆失败</li>
</ol>
<h2 id="项目下载"><a href="#项目下载" class="headerlink" title="项目下载"></a>项目下载</h2><p>由于项目的内容比较多，所以可以下载到开发环境里测试: <a href="/download/spring-security.7z">spring-security.7z</a></p>

        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/wx-tips/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          小程序 Tips
        
      </div>
    </a>
  
  
    <a href="/qtbook-misc-regex/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">实用正则表达式</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

<script>
  if (window.mermaid) {
    mermaid.initialize({
		securityLevel: 'loose',
		theme: 'dark',
	});
  }
</script>

    </div>
</body>

</html>
