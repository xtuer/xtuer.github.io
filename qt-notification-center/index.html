<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>观察者模式的 NotificationCenter | 公孙二狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Qt 的信号槽在解耦方面做的非常好，sender 和 receiver 不需要互相知道，但是在使用 QObject::connect() 建立信号槽连接的时候是必须要同时知道 sender 和 receiver 的，这在绝大多数时候都是非常好用的，但是如果只想发送通知后，对此通知感兴趣的监听者就能自动的收到通知，同时还不用 QObject::connect() 建立信号槽连接，就可以使用下面介绍的">
<meta property="og:type" content="article">
<meta property="og:title" content="观察者模式的 NotificationCenter">
<meta property="og:url" content="http://xtuer.github.io/qt-notification-center/index.html">
<meta property="og:site_name" content="公孙二狗">
<meta property="og:description" content="Qt 的信号槽在解耦方面做的非常好，sender 和 receiver 不需要互相知道，但是在使用 QObject::connect() 建立信号槽连接的时候是必须要同时知道 sender 和 receiver 的，这在绝大多数时候都是非常好用的，但是如果只想发送通知后，对此通知感兴趣的监听者就能自动的收到通知，同时还不用 QObject::connect() 建立信号槽连接，就可以使用下面介绍的">
<meta property="og:locale">
<meta property="article:published_time" content="2016-11-12T06:51:23.000Z">
<meta property="article:modified_time" content="2021-12-02T22:29:07.170Z">
<meta property="article:author" content="公孙二狗">
<meta property="article:tag" content="Qt">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="公孙二狗" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/dog.png">
  
  
<link rel="stylesheet" href="/css/style.css">


  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/require.js/2.3.6/require.min.js"></script> -->
  <link href="/css/fonts/font-awesome.min.css" rel="stylesheet">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/require.min.js"></script>
  <script src="/js/main.js"></script>

  <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <!-- <script src="https://hm.baidu.com/hm.js?22778d8041aa1437b11529a3e87a0a12"></script> -->
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <div id="container">
        <div class="left-col">
            <div class="content-table">Content Table</div>
            <div class="overlay"></div>

<ul class="menu">
    <!-- <li class="item"><a href="javascript:void(0)" id="baidu-search-button">百度搜索</a></li> -->
    <!-- <li class="item"><a href="javascript:void(0)" id="google-search-button">谷歌搜索</a></li> -->
    <!-- <li class="item non-index-item"><a href="javascript:void(0)" id="show-toc-button">显示目录</a></li> -->
</ul>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/all/"></a></h1>
		</hgroup>
		<p style=" margin-bottom: 10px;margin-top: -5px;">
			<a style="color: gray;" target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=26664141&site=qq&menu=yes">QQ: 26664141</a>
		</p>

		
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-ribbon" data-idx="1">
							<div class="ribbon"></div>
						</div>
						<div class="icon-wrap icon-house hide" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Tags</li>
						<li>Menu</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				
				<section class="switch-part switch-part1">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ajax/" style="font-size: 10.56px;">Ajax</a> <a href="/tags/Cas/" style="font-size: 12.22px;">Cas</a> <a href="/tags/DB/" style="font-size: 15px;">DB</a> <a href="/tags/FE/" style="font-size: 20px;">FE</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Gradle/" style="font-size: 13.89px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 12.22px;">Hexo</a> <a href="/tags/Index/" style="font-size: 12.78px;">Index</a> <a href="/tags/Java/" style="font-size: 19.44px;">Java</a> <a href="/tags/Mac/" style="font-size: 16.67px;">Mac</a> <a href="/tags/Misc/" style="font-size: 17.22px;">Misc</a> <a href="/tags/PHP/" style="font-size: 11.11px;">PHP</a> <a href="/tags/Qt/" style="font-size: 18.33px;">Qt</a> <a href="/tags/QtBook/" style="font-size: 18.89px;">QtBook</a> <a href="/tags/Redis/" style="font-size: 11.11px;">Redis</a> <a href="/tags/SemanticUi/" style="font-size: 13.89px;">SemanticUi</a> <a href="/tags/Spring/" style="font-size: 11.67px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.33px;">SpringBoot</a> <a href="/tags/SpringCore/" style="font-size: 15.56px;">SpringCore</a> <a href="/tags/SpringMVC/" style="font-size: 14.44px;">SpringMVC</a> <a href="/tags/SpringSecurity/" style="font-size: 15px;">SpringSecurity</a> <a href="/tags/SpringWeb/" style="font-size: 17.78px;">SpringWeb</a> <a href="/tags/Util/" style="font-size: 17.78px;">Util</a> <a href="/tags/Vue/" style="font-size: 16.11px;">Vue</a> <a href="/tags/zTree/" style="font-size: 11.67px;">zTree</a>
                    </div>
                    <script>

                    </script>
				</section>
				

				<section class="switch-part switch-part2">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://loadship.cn">小鱼人</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://qtnull.com/">千古</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">吞风吻雨葬落日未曾彷徨，欺山赶海践雪径也未绝望，拈花把酒偏折煞世人情狂，凭这两眼与百臂或千手不能防，天阔阔雪漫漫共谁同航，这沙滚滚水皱皱笑着浪荡，贪欢一晌偏教那女儿情长埋葬。</div>
				</section>
				
			</div>
		</div>
        <div class="links-area" style="margin-top: 10px;">
            <a href="/html/tools">收藏夹 |</a>
            <a href="/qtbook">Qt 杂谈 |</a>
            <a href="/html/vue-in-action">Vue 实践</a>
            <a href="/html/spring-boot">Spring Boot |</a>
            <a href="/spring-web-index">Java Web 开发</a>
        </div>
	</header>
</div>

<script>
    $(document).ready(function() {
        // Baidu 搜索
        // $('#baidu-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.baidu.com/s?wd=site:qtdebug.com+'+text);
        //     });
        // });
        //
        // // Google 搜索
        // $('#google-search-button').click(function(event) {
        //     layer.prompt({title: false, formType: 0, closeBtn: 0, maxlength: 140}, function(text, index) {
        //         layer.close(index);
        //         window.open('https://www.google.com/?#q=site:qtdebug.com+'+text);
        //     });
        // });
    });

    function resetTags() {
		var tags = $(".tagcloud a");
		tags.css({"font-size": "12px"});
		for(var i=0,len=tags.length; i<len; i++){
			var num = tags.eq(i).html().length % 5 +1;
			tags[i].className = "";
			tags.eq(i).addClass("color"+num);
		}
    }

    resetTags();
</script>

        </div>
        <div class="mid-col">
            <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/dog.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

            <div class="body-wrap"><!-- 生成目录 -->

    <div id="toc-mask" style="display: none;">
        <div class="toc-container">
            <div class="article-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">文件说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NotificationCenter-h-and-NotificationCenter-cpp"><span class="toc-text">NotificationCenter.h and NotificationCenter.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Singleton-h"><span class="toc-text">Singleton.h</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-cpp"><span class="toc-text">main.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FooObserver-h-and-FooObserver-cpp"><span class="toc-text">FooObserver.h and FooObserver.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BarObserver-h-and-BarObserver-cpp"><span class="toc-text">BarObserver.h and BarObserver.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NotifyThread-h-and-NotifyThread-cpp"><span class="toc-text">NotifyThread.h and NotifyThread.cpp</span></a></li></ol>
            </div>
        </div>
    </div>


<article id="post-qt-notification-center" class="article article-type-post" itemscope itemprop="blogPost">
    <!-- 
        <div class="content-table">Content Table</div>
     -->

    
        <div class="article-meta">
            <a href="/qt-notification-center/" class="article-date">
  	<!-- <time datetime="2016-11-12T06:51:23.000Z" itemprop="datePublished">2016-11-12</time> -->
    2016-11-12
</a>

        </div>
    

    
        <div class="article-inner article-inner-x">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      观察者模式的 NotificationCenter
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Qt/" rel="tag">Qt</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
        
            <p>Qt 的信号槽在解耦方面做的非常好，sender 和 receiver 不需要互相知道，但是在使用 QObject::connect() 建立信号槽连接的时候是必须要同时知道 sender 和 receiver 的，这在绝大多数时候都是非常好用的，但是如果只想发送通知后，对此通知感兴趣的监听者就能自动的收到通知，同时还不用 QObject::connect() 建立信号槽连接，就可以使用下面介绍的 <code>NotificationCenter</code> 来实现。此外，NotificationCenter 内部已经处理好了跨线程通讯，不需要再考虑不同线程间函数调用的头疼问题。</p>
<p><strong>NotificationCenter 的使用:</strong></p>
<ul>
<li><p>通知的监听器，不需要使用继承，只需要实现函数 <code>notified</code>，当有通知的时候，<code>notified</code> 函数会被自动调用</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">notified</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li><p>监听某个通知，通知的标志是一个整数，可以根据业务随意定义</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton&lt;NotificationCenter&gt;::<span class="built_in">getInstance</span>().<span class="built_in">addObserver</span>(<span class="number">1</span>, &amp;foo);</span><br></pre></td></tr></table></figure></li>
<li><p>发送通知, 只需要和 NotificationCenter 交互就能发送和接收通知</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Singleton&lt;NotificationCenter&gt;::<span class="built_in">getInstance</span>().<span class="built_in">notify</span>(<span class="number">1</span>, <span class="built_in">QString</span>(<span class="string">&quot;Two&quot;</span>).<span class="built_in">toUtf8</span>()); <span class="comment">// 同线程发送消息</span></span><br><span class="line"><span class="built_in">NOTIFY_CROSS_THREAD</span>(<span class="number">2</span>, <span class="built_in">QString</span>(<span class="string">&quot;Two&quot;</span>).<span class="built_in">toUtf8</span>()); <span class="comment">// 跨线程发送消息，也可同线程</span></span><br></pre></td></tr></table></figure></li>
<li><p>删除监听器，不再需要的时候，从 NotificationCenter 删除监听器，以免造成野指针异常</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Singleton&lt;NotificationCenter&gt;::<span class="built_in">getInstance</span>().<span class="built_in">removeObserver</span>(&amp;foo);</span><br><span class="line">Singleton&lt;NotificationCenter&gt;::<span class="built_in">getInstance</span>().<span class="built_in">removeObserver</span>(<span class="number">1</span>, &amp;foo);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>NotificationCenter 什么时候使用? 以 QTcpSocket 通讯为例:</strong><br>使用信号槽和 NotificationCenter 都可以完成任务，但是 NotificationCenter 也是个不错的选择</p>
<ul>
<li>如果每一种消息都对应一个信号，则一般都会对应一个槽函数(对创建太多函数总有莫名的恐惧感)</li>
<li>消息的种类会很多，就会需要太多的信号槽</li>
<li>需要使用 connect() 給信号槽对应的创建连接</li>
<li>如果要增加新的消息类型时，则要创建它的槽函数和建立连接</li>
<li>也许你会说，所有的消息都用同一个信号和槽函数，因为可以在发射时传入消息的种类，在槽函数里也是能区别消息的。是的，这确实是一个不错的方法，这种做法和我们的 NotificationCenter 其实就差不多一样了，但是有点区别的是它会把所有的消息都发送到槽函数里，不需要的也会发送，例如有 100 种消息，即使只对其中 2 种消息感兴趣，但是它也会收到另外的 98 种消息。 而使用 NotificationCenter 时只会收到你感兴趣的 2 种消息。</li>
<li>还有一点，NotificationCenter 中通知的监听器注册只需要关心通知的 ID，这个 ID 是根据业务需求定义的一个整数，不需要知道通知的发送者，但是建立信号槽连接时 sender 和 receiver 都需要知道，这也是相对方便的一点。</li>
</ul>
<blockquote>
<p>文中的 <code>监听器</code>，<code>观察者</code> 指的是同一个意思；<code>消息</code>，<code>通知</code> 也是同一个意思。</p>
</blockquote>
<span id="more"></span>

<h2 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h2><ul>
<li>NotificationCenter 实现的文件包含<ul>
<li>NotificationCenter.h</li>
<li>NotificationCenter.cpp</li>
<li>Singleton.h</li>
</ul>
</li>
<li>以下几个文件是用于测试使用的<ul>
<li>main.cpp</li>
<li>FooObserver.h and FooObserver.cpp</li>
<li>BarObserver.h and BarObserver.cpp</li>
<li>NotifyThread.h and NotifyThread.cpp</li>
</ul>
</li>
</ul>
<h2 id="NotificationCenter-h-and-NotificationCenter-cpp"><a href="#NotificationCenter-h-and-NotificationCenter-cpp" class="headerlink" title="NotificationCenter.h and NotificationCenter.cpp"></a>NotificationCenter.h and NotificationCenter.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NOTIFICATIONCENTER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NOTIFICATIONCENTER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSet&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHash&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMetaObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Singleton.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果发送通知的线程不是主线程，因为 NotificationCenter 的对象是主线程创建的，则调用此宏发送，当然，同线程也可以使用这个宏来发送消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NOTIFY_CROSS_THREAD(notificationId, data) QMetaObject::invokeMethod(&amp;Singleton<span class="meta-string">&lt;NotificationCenter&gt;</span>::getInstance(), \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;notify&quot;</span>, Q_ARG(int, notificationId), Q_ARG(QByteArray, data));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 使用观察者模式实现的通知中心，解耦观察者和被观察者，他们无须互相知道，Qt 的信号槽也是观察者模式，在 connect 的时候需要知道 sender 和 receiver，</span></span><br><span class="line"><span class="comment"> * 而通过通知中心发消息的话，通知发送方和接收方都只和通知中心交互: 观察者只需要监听某个通知，不需要知道通知是谁发送的，通知发送者也只管通过通知中心发送通知即可。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意：观察者需要实现 SLOT 或者 Q_INVOKABLE 的函数 void notified(int notificationId, const QByteArray &amp;data)，这个函数通把通知发送給对应的观察者。</span></span><br><span class="line"><span class="comment"> * 为了简单不再多加个继承，所以没有为观察者定义一个抽象类的接口，然后观察者去继承实现这个抽象类的方法。因为使用了 QMetaObject::invokeMethod() 来实现</span></span><br><span class="line"><span class="comment"> * 有通知到达的调用，而且这样做还有一个好处是可以解决跨线程调用的问题。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 如果通知的观察者没有实现 notified() 函数，则程序运行时会在命令行输出错误: QMetaObject::invokeMethod: No such method Xxxx::notified(int,QByteArray)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationCenter</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">    <span class="function">Q_OBJECT</span></span><br><span class="line"><span class="function">    <span class="title">SINGLETON</span><span class="params">(NotificationCenter)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span>:</span></span><br><span class="line"><span class="function">    /**</span></span><br><span class="line"><span class="function">     * @brief 給传入的 notificationId 添加观察者 observer</span></span><br><span class="line"><span class="function">     *</span></span><br><span class="line"><span class="function">     * @param notificationId 通知的 id</span></span><br><span class="line"><span class="function">     * @param observer 观察者</span></span><br><span class="line"><span class="function">     */</span></span><br><span class="line"><span class="function">    Q_INVOKABLE void addObserver(int notificationId, QObject *observer);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 删除 notificationId 的观察者 observer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param notificationId 通知的 id</span></span><br><span class="line"><span class="comment">     * @param observer 观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(<span class="keyword">int</span> notificationId, QObject *observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 删除所有通知的观察者 observer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param observer 观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(QObject *observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 給观察者发送 notificationId 的通知，通知的内容为 QByteArray。</span></span><br><span class="line"><span class="comment">     * 使用 QByteArray 是为了便于利用 QDataStream 序列化和反序列化。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param notificationId 通知的 id</span></span><br><span class="line"><span class="comment">     * @param data 通知的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">notify</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QHash&lt;<span class="keyword">int</span>, QSet&lt;QObject*&gt; &gt; observers; <span class="comment">// 某一个通知的观察者: key 是通知的 id，value 是订阅了这个通知的所有观察者</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// NOTIFICATIONCENTER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotificationCenter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QList&gt;</span></span></span><br><span class="line"></span><br><span class="line">NotificationCenter::<span class="built_in">NotificationCenter</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">NotificationCenter::~<span class="built_in">NotificationCenter</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加观察者</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotificationCenter::addObserver</span><span class="params">(<span class="keyword">int</span> notificationId, QObject *observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == observer) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line">    QSet&lt;QObject*&gt; &amp;obs = observers[notificationId];</span><br><span class="line">    obs.<span class="built_in">insert</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除观察者</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotificationCenter::removeObserver</span><span class="params">(<span class="keyword">int</span> notificationId, QObject *observer)</span> </span>&#123;</span><br><span class="line">    QSet&lt;QObject*&gt; &amp;obs = observers[notificationId];</span><br><span class="line">    obs.<span class="built_in">remove</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除观察者</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotificationCenter::removeObserver</span><span class="params">(QObject *observer)</span> </span>&#123;</span><br><span class="line">    QList&lt;<span class="keyword">int</span>&gt; notificationIds = observers.<span class="built_in">keys</span>();</span><br><span class="line"></span><br><span class="line">    foreach (<span class="keyword">int</span> notificationId, notificationIds) &#123;</span><br><span class="line">        <span class="built_in">removeObserver</span>(notificationId, observer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 給观察者发送通知</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotificationCenter::notify</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span> </span>&#123;</span><br><span class="line">    QSet&lt;QObject*&gt; obs = observers[notificationId];</span><br><span class="line"></span><br><span class="line">    foreach(QObject *observer, obs) &#123;</span><br><span class="line">        QMetaObject::<span class="built_in">invokeMethod</span>(observer, <span class="string">&quot;notified&quot;</span>, <span class="built_in">Q_ARG</span>(<span class="keyword">int</span>, notificationId), <span class="built_in">Q_ARG</span>(QByteArray, data)); <span class="comment">// 使用 invokeMethod 是为可跨线程进行函数调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Singleton-h"><a href="#Singleton-h" class="headerlink" title="Singleton.h"></a>Singleton.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SINGLETON_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SINGLETON_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QScopedPointer&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">///                            Singleton signature                           ///</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类模版 Singleton 用于辅助实现单例模式。</span></span><br><span class="line"><span class="comment"> * 使用方法，以定义类 ConnectionPool 的单例实现为例:</span></span><br><span class="line"><span class="comment"> * 0. 包含单例的头文件:</span></span><br><span class="line"><span class="comment"> *    #include &quot;Singleton.h&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. 声明类要实现单例:</span></span><br><span class="line"><span class="comment"> *    class ConnectionPool &#123;</span></span><br><span class="line"><span class="comment"> *        SINGLETON(ConnectionPool) // Here</span></span><br><span class="line"><span class="comment"> *    public:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. 实现单例类默认的构造函数和析构函数</span></span><br><span class="line"><span class="comment"> *    ConnectionPool::ConnectionPool() &#123;&#125;;</span></span><br><span class="line"><span class="comment"> *    ConnectionPool::~ConnectionPool() &#123;&#125;;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. 获取单例类的对象，就可以调用它的函数了:</span></span><br><span class="line"><span class="comment"> *    QSqlDatabase connection = Singleton&lt;ConnectionPool&gt;::getInstance().getConnection();</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    ConnectionPool &amp;pool = Singleton&lt;ConnectionPool&gt;::getInstance();</span></span><br><span class="line"><span class="comment"> *    QSqlDatabase connection = pool.getConnection();</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意: 如果单例的类需要释放的资源和 Qt 底层的信号系统有关系，例如 QSettings，QSqlDatabase 等，</span></span><br><span class="line"><span class="comment"> *    需要在程序结束前手动释放(也就是在 main() 函数返回前调用释放资源的函数)，</span></span><br><span class="line"><span class="comment"> *    否则有可能在程序退出时报系统底层的信号错误，导致如 QSettings 的数据没有保存。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> T&amp; <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="keyword">const</span> Singleton &amp;other);</span><br><span class="line">    Singleton&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Singleton &amp;other);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> QMutex mutex;</span><br><span class="line">    <span class="keyword">static</span> QScopedPointer&lt;T&gt; instance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">///                            Singleton definition                          ///</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; QMutex Singleton&lt;T&gt;::mutex;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; QScopedPointer&lt;T&gt; Singleton&lt;T&gt;::instance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T&amp; Singleton&lt;T&gt;::<span class="built_in">getInstance</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance.<span class="built_in">isNull</span>()) &#123;</span><br><span class="line">        mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span> (instance.<span class="built_in">isNull</span>()) &#123;</span><br><span class="line">            instance.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">T</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        mutex.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *instance.<span class="built_in">data</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">///                               Singleton Macro                            ///</span></span><br><span class="line"><span class="comment">///                                                                          ///</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SINGLETON(Class)                        \</span></span><br><span class="line"><span class="meta">private:                                        \</span></span><br><span class="line"><span class="meta">    Class();                                    \</span></span><br><span class="line"><span class="meta">    ~Class();                                   \</span></span><br><span class="line"><span class="meta">    Class(const Class &amp;other);                  \</span></span><br><span class="line"><span class="meta">    Class&amp; operator=(const Class &amp;other);       \</span></span><br><span class="line"><span class="meta">    friend class Singleton<span class="meta-string">&lt;Class&gt;</span>;              \</span></span><br><span class="line"><span class="meta">    friend struct QScopedPointerDeleter<span class="meta-string">&lt;Class&gt;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// SINGLETON_H</span></span></span><br></pre></td></tr></table></figure>

<h2 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotificationCenter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FooObserver.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BarObserver.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Message.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotifyThread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    NotificationCenter &amp;nc = Singleton&lt;NotificationCenter&gt;::<span class="built_in">getInstance</span>();</span><br><span class="line">    FooObserver foo; <span class="comment">// 通知的观察者</span></span><br><span class="line">    BarObserver bar; <span class="comment">// 通知的观察者</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] 测试添加观察者</span></span><br><span class="line">    <span class="comment">// 通知 1 有 2 个观察者 foo and bar</span></span><br><span class="line">    <span class="comment">// 通知 1 有 1 个观察者 bar</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;---------------- foo and bar 都能收到通知 1 和 2 ----------------&quot;</span>;</span><br><span class="line">    nc.<span class="built_in">addObserver</span>(<span class="number">1</span>, &amp;foo);</span><br><span class="line">    nc.<span class="built_in">addObserver</span>(<span class="number">1</span>, &amp;bar);</span><br><span class="line">    nc.<span class="built_in">addObserver</span>(<span class="number">2</span>, &amp;bar);</span><br><span class="line">    nc.<span class="built_in">notify</span>(<span class="number">1</span>, <span class="built_in">QString</span>(<span class="string">&quot;One&quot;</span>).<span class="built_in">toUtf8</span>()); <span class="comment">// foo and bar 都收到消息</span></span><br><span class="line">    <span class="built_in">NOTIFY_CROSS_THREAD</span>(<span class="number">2</span>, <span class="built_in">QString</span>(<span class="string">&quot;Two&quot;</span>).<span class="built_in">toUtf8</span>()); <span class="comment">// bar 收到消息(使用宏发送通知)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [2] 测试删除观察者</span></span><br><span class="line">    <span class="comment">// 删除通知 1 的观察者 bar，它还剩下观察者 foo</span></span><br><span class="line">    <span class="comment">// 通知 2 有观察者 bar</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;---------------- bar 不再收到通知 1，但能收到通知 2 ----------------&quot;</span>;</span><br><span class="line">    nc.<span class="built_in">removeObserver</span>(<span class="number">1</span>, &amp;bar); <span class="comment">// nc.removeObserver(&amp;bar) 则 bar 不在接收到任何通知</span></span><br><span class="line">    nc.<span class="built_in">notify</span>(<span class="number">1</span>, <span class="built_in">QString</span>(<span class="string">&quot;Three&quot;</span>).<span class="built_in">toUtf8</span>()); <span class="comment">// foo 收到消息</span></span><br><span class="line">    nc.<span class="built_in">notify</span>(<span class="number">2</span>, <span class="built_in">QString</span>(<span class="string">&quot;Four&quot;</span>).<span class="built_in">toUtf8</span>());  <span class="comment">// bar 收到消息，删除通知 1 的观察者，通知 2 的观察者不受影响</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [3] 测试把对象序列化和反序列化</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;---------------- 序列化例子 ----------------&quot;</span>;</span><br><span class="line">    nc.<span class="built_in">addObserver</span>(<span class="number">3</span>, &amp;foo);</span><br><span class="line">    <span class="function">Message <span class="title">msg</span><span class="params">(<span class="number">12345</span>, <span class="string">&quot;你是谁？你从哪里来？你要到哪里去？&quot;</span>)</span></span>;</span><br><span class="line">    nc.<span class="built_in">notify</span>(<span class="number">3</span>, msg.<span class="built_in">toByteArray</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [4] 跨线程发送通知</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;---------------- 跨线程发送通知 ----------------&quot;</span>;</span><br><span class="line">    nc.<span class="built_in">addObserver</span>(<span class="number">4</span>, &amp;foo);</span><br><span class="line">    NotifyThread thread;</span><br><span class="line">    thread.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---------------- foo and bar 都能收到通知 1 和 2 ----------------</span><br><span class="line">NotificationID:  1  -  FooObserver:  &quot;One&quot;</span><br><span class="line">NotificationID:  1  -  BarObserver:  &quot;One&quot;</span><br><span class="line">NotificationID:  2  -  BarObserver:  &quot;Two&quot;</span><br><span class="line">---------------- bar 不再收到通知 1 ----------------</span><br><span class="line">NotificationID:  1  -  FooObserver:  &quot;Three&quot;</span><br><span class="line">NotificationID:  2  -  BarObserver:  &quot;Four&quot;</span><br><span class="line">---------------- 序列化例子 ----------------</span><br><span class="line">NotificationID:  3  -  FooObserver:  &quot;Type: 12345, Content: 你是谁？你从哪里来？你要到哪里去？&quot;</span><br><span class="line">---------------- 跨线程发送通知 ----------------</span><br><span class="line">NotifyThread:    NotifyThread(0x7fff519ed910)</span><br><span class="line">NotificationID:  4  -  FooObserver:  &quot;870&quot; - in thread:  QThread(0x7fbfc0c04690)</span><br><span class="line">NotificationID:  4  -  FooObserver:  &quot;345&quot; - in thread:  QThread(0x7fbfc0c04690)</span><br></pre></td></tr></table></figure>

<h2 id="FooObserver-h-and-FooObserver-cpp"><a href="#FooObserver-h-and-FooObserver-cpp" class="headerlink" title="FooObserver.h and FooObserver.cpp"></a>FooObserver.h and FooObserver.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FOOOBSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOOOBSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooObserver</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">FooObserver</span><span class="params">(QObject *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">notified</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// FOOOBSERVER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FooObserver.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QThread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Message.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">FooObserver::<span class="built_in">FooObserver</span>(QObject *parent) : <span class="built_in">QObject</span>(parent) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FooObserver::notified</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">3</span> == notificationId) &#123;</span><br><span class="line">        <span class="comment">// notificationId 为 3 说明接收到的通知是 Message</span></span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;NotificationID: &quot;</span> &lt;&lt; notificationId &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; <span class="string">&quot;FooObserver: &quot;</span> &lt;&lt; Message::<span class="built_in">fromByteArray</span>(data).<span class="built_in">toString</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">4</span> == notificationId) &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;NotificationID: &quot;</span> &lt;&lt; notificationId &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; <span class="string">&quot;FooObserver: &quot;</span> &lt;&lt; data &lt;&lt; <span class="string">&quot;- in thread: &quot;</span> &lt;&lt; QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;NotificationID: &quot;</span> &lt;&lt; notificationId &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; <span class="string">&quot;FooObserver: &quot;</span> &lt;&lt; data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BarObserver-h-and-BarObserver-cpp"><a href="#BarObserver-h-and-BarObserver-cpp" class="headerlink" title="BarObserver.h and BarObserver.cpp"></a>BarObserver.h and BarObserver.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BAROBSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BAROBSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BarObserver</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">BarObserver</span><span class="params">(QObject *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">notified</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// BAROBSERVER_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BarObserver.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">BarObserver::<span class="built_in">BarObserver</span>(QObject *parent) : <span class="built_in">QObject</span>(parent) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BarObserver::notified</span><span class="params">(<span class="keyword">int</span> notificationId, <span class="keyword">const</span> QByteArray &amp;data)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;NotificationID: &quot;</span> &lt;&lt; notificationId &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; <span class="string">&quot;BarObserver: &quot;</span> &lt;&lt; data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NotifyThread-h-and-NotifyThread-cpp"><a href="#NotifyThread-h-and-NotifyThread-cpp" class="headerlink" title="NotifyThread.h and NotifyThread.cpp"></a>NotifyThread.h and NotifyThread.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NOTIFYTHREAD_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NOTIFYTHREAD_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QThread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotifyThread</span> :</span> <span class="keyword">public</span> QThread &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NotifyThread</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> Q_DECL_OVERRIDE</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// NOTIFYTHREAD_H</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotifyThread.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotificationCenter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDateTime&gt;</span></span></span><br><span class="line"></span><br><span class="line">NotifyThread::<span class="built_in">NotifyThread</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotifyThread::run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;NotifyThread: &quot;</span> &lt;&lt; QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qsrand</span>(QDateTime::<span class="built_in">currentDateTime</span>().<span class="built_in">toMSecsSinceEpoch</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">NOTIFY_CROSS_THREAD</span>(<span class="number">4</span>, QString::<span class="built_in">number</span>(<span class="built_in">qrand</span>() % <span class="number">900</span> + <span class="number">100</span>).<span class="built_in">toUtf8</span>());</span><br><span class="line"></span><br><span class="line">        QThread::<span class="built_in">msleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
    </div>
    
  </div>
  
  
    
<nav id="article-nav">
  
    <a href="/qtbook-misc-single-application/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Single Application
        
      </div>
    </a>
  
  
    <a href="/mac-forklift/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">ForkLift 记住 FTP 密码</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  

</article>




    <script>
        $(document).ready(function() {
            // 显示 content table
            $('.content-table').show();
            $('.menu .item.non-index-item').show();

            var $tocMask = $('#toc-mask');

            $(document).keyup(function(e) {
                // 按下数字 1，toggle content table
                if (e.keyCode == 49) {
                    // $tocMask.toggle();
                    $tocMask.fadeIn('fast');
                }
            });

            $(document).on('click', '#show-toc-button, .content-table', function() {
                // $tocMask.toggle();
                $tocMask.fadeIn('fast');
            });

            // 隐藏 Mask
            $(document).on('click', '#toc-mask, #toc-mask .toc-link', function() {
                // $tocMask.hide();
                $tocMask.fadeOut('fast');
            });
        });
    </script>

</div>
            <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <p>Hosted by <a target="_blank" rel="noopener" href="https://github.com">Github Pages</a></p>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> Mod
            </div>
        </div>

        <!-- 卜算子 -->
        
    </div>
</footer>

        </div>
        

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: false,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<!-- 
<script src="/js/main.js"></script>
 -->

<!--



 -->

    </div>
</body>

</html>
